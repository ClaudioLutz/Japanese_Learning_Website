{% extends "admin/base_admin.html" %}

{% block title %}Manage Lessons - Admin Panel{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Manage Lessons</h2>
                <button type="button" class="btn btn-primary" onclick="openModal('addLessonModal')">
                    <i class="fas fa-plus"></i> Add New Lesson
                </button>
            </div>

            <!-- Lessons Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">All Lessons</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped" id="lessonsTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Type</th>
                                    <th>Difficulty</th>
                                    <th>Duration</th>
                                    <th>Content Items</th>
                                    <th>Published</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Content will be loaded via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Lesson Modal -->
<div id="addLessonModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h4>Add New Lesson</h4>
            <span class="close" onclick="closeModal('addLessonModal')">&times;</span>
        </div>
        <form id="addLessonForm">
            {{ form.csrf_token }}
            <div class="modal-body">
                <div class="form-group">
                    <label for="lessonTitle">Title *</label>
                    <input type="text" id="lessonTitle" name="title" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="lessonDescription">Description</label>
                    <textarea id="lessonDescription" name="description" class="form-control" rows="3"></textarea>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="lessonType">Type *</label>
                            <select id="lessonType" name="lesson_type" class="form-control" required>
                                <option value="">Select Type</option>
                                <option value="free">Free</option>
                                <option value="premium">Premium</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="lessonCategory">Category</label>
                            <select id="lessonCategory" name="category_id" class="form-control">
                                <option value="">Select Category</option>
                                <!-- Categories will be loaded via JavaScript -->
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="lessonDifficulty">Difficulty (1-5)</label>
                            <input type="number" id="lessonDifficulty" name="difficulty_level" class="form-control" min="1" max="5">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="lessonDuration">Duration (minutes)</label>
                            <input type="number" id="lessonDuration" name="estimated_duration" class="form-control" min="1">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="lessonOrder">Order Index</label>
                            <input type="number" id="lessonOrder" name="order_index" class="form-control" min="0" value="0">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="lessonThumbnail">Thumbnail URL</label>
                    <input type="url" id="lessonThumbnail" name="thumbnail_url" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="lessonVideo">Video Intro URL</label>
                    <input type="url" id="lessonVideo" name="video_intro_url" class="form-control">
                </div>
                
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" id="lessonPublished" name="is_published" class="form-check-input">
                        <label for="lessonPublished" class="form-check-label">Published</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addLessonModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Lesson</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Lesson Modal -->
<div id="editLessonModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h4>Edit Lesson</h4>
            <span class="close" onclick="closeModal('editLessonModal')">&times;</span>
        </div>
        <form id="editLessonForm">
            {{ form.csrf_token }}
            <input type="hidden" id="editLessonId" name="id">
            <div class="modal-body">
                <div class="form-group">
                    <label for="editLessonTitle">Title *</label>
                    <input type="text" id="editLessonTitle" name="title" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="editLessonDescription">Description</label>
                    <textarea id="editLessonDescription" name="description" class="form-control" rows="3"></textarea>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="editLessonType">Type *</label>
                            <select id="editLessonType" name="lesson_type" class="form-control" required>
                                <option value="">Select Type</option>
                                <option value="free">Free</option>
                                <option value="premium">Premium</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="editLessonCategory">Category</label>
                            <select id="editLessonCategory" name="category_id" class="form-control">
                                <option value="">Select Category</option>
                                <!-- Categories will be loaded via JavaScript -->
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="editLessonDifficulty">Difficulty (1-5)</label>
                            <input type="number" id="editLessonDifficulty" name="difficulty_level" class="form-control" min="1" max="5">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="editLessonDuration">Duration (minutes)</label>
                            <input type="number" id="editLessonDuration" name="estimated_duration" class="form-control" min="1">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="editLessonOrder">Order Index</label>
                            <input type="number" id="editLessonOrder" name="order_index" class="form-control" min="0">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editLessonThumbnail">Thumbnail URL</label>
                    <input type="url" id="editLessonThumbnail" name="thumbnail_url" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="editLessonVideo">Video Intro URL</label>
                    <input type="url" id="editLessonVideo" name="video_intro_url" class="form-control">
                </div>
                
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" id="editLessonPublished" name="is_published" class="form-check-input">
                        <label for="editLessonPublished" class="form-check-label">Published</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('editLessonModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Lesson</button>
            </div>
        </form>
    </div>
</div>

<!-- Lesson Content Modal -->
<div id="lessonContentModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h4>Manage Lesson Content</h4>
            <span class="close" onclick="closeModal('lessonContentModal')">&times;</span>
        </div>
        <div class="modal-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 id="contentLessonTitle">Lesson Content</h5>
                <button type="button" class="btn btn-sm btn-primary" onclick="openAddContentModal()">
                    <i class="fas fa-plus"></i> Add Content
                </button>
            </div>
            
            <div class="table-responsive">
                <table class="table table-sm" id="lessonContentTable">
                    <thead>
                        <tr>
                            <th>Order</th>
                            <th>Type</th>
                            <th>Title</th>
                            <th>Optional</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Content will be loaded via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('lessonContentModal')">Close</button>
        </div>
    </div>
</div>

<!-- Enhanced Add Content Wizard Modal -->
<div id="addContentModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h4 id="addContentModalTitle">Add Content to Lesson</h4>
            <span class="close" onclick="closeModal('addContentModal')">&times;</span>
        </div>
        <div class="modal-body">
            <!-- Step 1: Content Type Selection -->
            <div id="contentTypeStep" class="content-step">
                <h5 class="mb-4">Choose Content Type:</h5>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="content-type-card" onclick="selectContentType('kana')">
                            <div class="card h-100 text-center">
                                <div class="card-body">
                                    <div class="content-type-icon">📝</div>
                                    <h6 class="card-title">Kana</h6>
                                    <p class="card-text small">Hiragana & Katakana characters</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="content-type-card" onclick="selectContentType('kanji')">
                            <div class="card h-100 text-center">
                                <div class="card-body">
                                    <div class="content-type-icon">🔤</div>
                                    <h6 class="card-title">Kanji</h6>
                                    <p class="card-text small">Chinese characters</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="content-type-card" onclick="selectContentType('vocabulary')">
                            <div class="card h-100 text-center">
                                <div class="card-body">
                                    <div class="content-type-icon">📚</div>
                                    <h6 class="card-title">Vocabulary</h6>
                                    <p class="card-text small">Words & phrases</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="content-type-card" onclick="selectContentType('grammar')">
                            <div class="card h-100 text-center">
                                <div class="card-body">
                                    <div class="content-type-icon">📖</div>
                                    <h6 class="card-title">Grammar</h6>
                                    <p class="card-text small">Grammar rules & patterns</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="content-type-card" onclick="selectContentType('text')">
                            <div class="card h-100 text-center">
                                <div class="card-body">
                                    <div class="content-type-icon">📄</div>
                                    <h6 class="card-title">Text</h6>
                                    <p class="card-text small">Custom text content</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="content-type-card" onclick="selectContentType('video')">
                            <div class="card h-100 text-center">
                                <div class="card-body">
                                    <div class="content-type-icon">🎥</div>
                                    <h6 class="card-title">Video</h6>
                                    <p class="card-text small">Video content (URL)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="content-type-card" onclick="selectContentType('audio')">
                            <div class="card h-100 text-center">
                                <div class="card-body">
                                    <div class="content-type-icon">🎵</div>
                                    <h6 class="card-title">Audio</h6>
                                    <p class="card-text small">Audio content (URL)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="content-type-card" onclick="selectContentType('image')">
                            <div class="card h-100 text-center">
                                <div class="card-body">
                                    <div class="content-type-icon">🖼️</div>
                                    <h6 class="card-title">Image</h6>
                                    <p class="card-text small">Image content (URL)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="content-type-card" onclick="selectContentType('interactive')">
                            <div class="card h-100 text-center">
                                <div class="card-body">
                                    <div class="content-type-icon">🎮</div>
                                    <h6 class="card-title">Interactive</h6>
                                    <p class="card-text small">Quizzes, questions, etc.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Content Configuration -->
            <div id="contentConfigStep" class="content-step" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 id="configStepTitle">Configure Content</h5>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="showContentTypeStep()">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                </div>
                
                <form id="contentConfigForm">
                    {{ form.csrf_token }}
                    <div id="contentConfigFields">
                        <!-- Dynamic form fields will be inserted here -->
                    </div>

                    <!-- Rich Text Content Section -->
                    <div id="richTextSection" style="display: none;">
                        <div class="form-group">
                            <label for="textContentTitle">Title *</label>
                            <input type="text" id="textContentTitle" name="title" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="textContentType">Content Type</label>
                            <select id="textContentType" name="text_content_type" class="form-control">
                                <option value="information_slide">Information Slide</option>
                                <option value="text_block">Text Block</option>
                                <option value="instructions">Instructions</option>
                                <option value="explanation">Explanation</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="richTextContent">Content *</label>
                            <textarea id="richTextContent" name="content_text" class="form-control rich-text-editor"></textarea>
                        </div>
                        
                        <!-- Content Template Selector -->
                        <div class="form-group">
                            <label>Quick Templates:</label>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="applyTemplate('basic_slide')">Basic Slide</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="applyTemplate('instruction_slide')">Instructions</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="applyTemplate('explanation_slide')">Explanation</button>
                            </div>
                        </div>
                        
                        <!-- Content Preview -->
                        <div class="form-group">
                            <label>Preview:</label>
                            <div id="richTextPreview" class="border p-3 bg-light" style="min-height: 100px;">
                                <em class="text-muted">Content preview will appear here...</em>
                            </div>
                        </div>
                    </div>

                    <!-- Interactive Content Section -->
                    <div id="interactiveSection" style="display: none;">
                        <div class="form-group">
                            <label for="interactiveTitle">Title *</label>
                            <input type="text" id="interactiveTitle" name="title" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="interactiveType">Interactive Type</label>
                            <select id="interactiveType" name="interactive_type" class="form-control" onchange="showInteractiveForm(this.value)">
                                <option value="">Select Type</option>
                                <option value="multiple_choice">Multiple Choice Question</option>
                                <option value="fill_blank">Fill in the Blank</option>
                                <option value="true_false">True/False</option>
                                <option value="matching">Matching Exercise</option>
                                <option value="quiz">Mini Quiz (Multiple Questions)</option>
                            </select>
                        </div>
                        
                        <!-- Multiple Choice Form -->
                        <div id="multipleChoiceForm" style="display: none;">
                            <div class="form-group">
                                <label for="mcQuestion">Question *</label>
                                <textarea id="mcQuestion" name="question_text" class="form-control rich-text-editor-simple" rows="3"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>Answer Options:</label>
                                <div id="mcOptions">
                                    <div class="option-item mb-2">
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <div class="input-group-text">
                                                    <input type="radio" name="correct_option" value="0">
                                                </div>
                                            </div>
                                            <input type="text" class="form-control" name="option_0" placeholder="Option A">
                                            <div class="input-group-append">
                                                <button type="button" class="btn btn-outline-danger" onclick="removeOption(0)">×</button>
                                            </div>
                                        </div>
                                        <small class="form-text text-muted">
                                            <input type="text" class="form-control form-control-sm mt-1" name="feedback_0" placeholder="Feedback for this option (optional)">
                                        </small>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addOption()">+ Add Option</button>
                            </div>
                            
                            <div class="form-group">
                                <label for="mcExplanation">Explanation (optional)</label>
                                <textarea id="mcExplanation" name="explanation" class="form-control" rows="2" placeholder="Explain why this is the correct answer"></textarea>
                            </div>
                        </div>
                        
                        <!-- Fill in the Blank Form -->
                        <div id="fillBlankForm" style="display: none;">
                            <div class="form-group">
                                <label for="fbQuestion">Question Text *</label>
                                <textarea id="fbQuestion" name="question_text" class="form-control" rows="3" placeholder="Use [BLANK] to indicate where students should fill in answers"></textarea>
                                <small class="form-text text-muted">Example: "The capital of Japan is [BLANK]."</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="fbAnswers">Correct Answers *</label>
                                <input type="text" id="fbAnswers" name="correct_answers" class="form-control" placeholder="Tokyo, tokyo, TOKYO (separate multiple acceptable answers with commas)">
                                <small class="form-text text-muted">List all acceptable answers, separated by commas. Case-insensitive.</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="fbExplanation">Explanation (optional)</label>
                                <textarea id="fbExplanation" name="explanation" class="form-control" rows="2"></textarea>
                            </div>
                        </div>
                        
                        <!-- True/False Form -->
                        <div id="trueFalseForm" style="display: none;">
                            <div class="form-group">
                                <label for="tfQuestion">Statement *</label>
                                <textarea id="tfQuestion" name="question_text" class="form-control" rows="3"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>Correct Answer</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="tf_answer" id="tfTrue" value="true">
                                    <label class="form-check-label" for="tfTrue">True</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="tf_answer" id="tfFalse" value="false">
                                    <label class="form-check-label" for="tfFalse">False</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="tfExplanation">Explanation *</label>
                                <textarea id="tfExplanation" name="explanation" class="form-control" rows="2" placeholder="Explain why this statement is true or false"></textarea>
                            </div>
                        </div>
                        
                        <!-- Quiz Settings -->
                        <div class="form-group">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="maxAttempts">Max Attempts</label>
                                    <input type="number" id="maxAttempts" name="max_attempts" class="form-control" value="3" min="1" max="10">
                                </div>
                                <div class="col-md-6">
                                    <label for="passingScore">Passing Score (%)</label>
                                    <input type="number" id="passingScore" name="passing_score" class="form-control" value="70" min="0" max="100">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Common fields for all content types -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="contentOrder">Order Index</label>
                                <input type="number" id="contentOrder" name="order_index" class="form-control" min="0" value="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <div class="form-check mt-4">
                                    <input type="checkbox" id="contentOptional" name="is_optional" class="form-check-input">
                                    <label for="contentOptional" class="form-check-label">Optional Content</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Step 3: Preview & Confirm -->
            <div id="contentPreviewStep" class="content-step" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5>Preview & Confirm</h5>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="showContentConfigStep()">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Content Preview</h6>
                    </div>
                    <div class="card-body" id="contentPreviewArea">
                        <!-- Preview content will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('addContentModal')">Cancel</button>
            <button type="button" id="previewBtn" class="btn btn-primary" onclick="previewContent()" style="display: none;">Preview</button>
            <button type="button" id="saveContentBtn" class="btn btn-success" onclick="saveContentToLesson()" style="display: none;">Add to Lesson</button>
        </div>
    </div>
</div>

<style>
.content-step {
    min-height: 400px;
}

.content-type-card {
    cursor: pointer;
    transition: transform 0.2s;
}

.content-type-card:hover {
    transform: translateY(-2px);
}

.content-type-card .card {
    border: 2px solid #e9ecef;
    transition: border-color 0.2s;
}

.content-type-card:hover .card {
    border-color: #007bff;
}

.content-type-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.form-group {
    margin-bottom: 1rem;
}

#contentPreviewArea {
    max-height: 300px;
    overflow-y: auto;
}

/* File Upload Styles */
.file-upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background-color: #f8f9fa;
}

.file-upload-area:hover {
    border-color: #007bff;
    background-color: #e3f2fd;
}

.file-upload-area.drag-over {
    border-color: #007bff;
    background-color: #e3f2fd;
    transform: scale(1.02);
}

.upload-placeholder {
    color: #6c757d;
}

.upload-placeholder i {
    margin-bottom: 1rem;
}

.upload-progress .progress {
    height: 8px;
    border-radius: 4px;
}

.upload-success {
    color: #28a745;
}

.btn-group-toggle .btn {
    margin-right: 0.5rem;
}

.btn-group-toggle .btn:last-child {
    margin-right: 0;
}
</style>

<script>
const contentTemplates = {
    basic_slide: `
        <h2>Slide Title</h2>
        <p>Your content goes here. You can use <strong>bold text</strong>, <em>italic text</em>, and other formatting.</p>
        <ul>
            <li>Bullet point 1</li>
            <li>Bullet point 2</li>
        </ul>
    `,
    
    instruction_slide: `
        <h2>📋 Instructions</h2>
        <p>Follow these steps:</p>
        <ol>
            <li><strong>Step 1:</strong> Description of first step</li>
            <li><strong>Step 2:</strong> Description of second step</li>
            <li><strong>Step 3:</strong> Description of third step</li>
        </ol>
        <div style="background-color: #e7f3ff; padding: 10px; border-left: 4px solid #2196F3; margin: 10px 0;">
            <strong>💡 Tip:</strong> Add helpful tips here
        </div>
    `,
    
    explanation_slide: `
        <h2>📚 Explanation</h2>
        <p>This section explains an important concept:</p>
        
        <h3>Key Points:</h3>
        <ul>
            <li><strong>Point 1:</strong> Explanation</li>
            <li><strong>Point 2:</strong> Explanation</li>
        </ul>
        
        <h3>Example:</h3>
        <div style="background-color: #f0f8f0; padding: 15px; border-radius: 5px; margin: 10px 0;">
            <p>Example content goes here...</p>
        </div>
        
        <h3>Remember:</h3>
        <div style="background-color: #fff3cd; padding: 10px; border-left: 4px solid #ffc107; margin: 10px 0;">
            <strong>⚠️ Important:</strong> Key takeaway message
        </div>
    `
};

function applyTemplate(templateName) {
    if (contentTemplates[templateName]) {
        tinymce.get('richTextContent').setContent(contentTemplates[templateName]);
        updateRichTextPreview();
    }
}

// Rich text editor management
let optionCount = 2; // Start with 2 options (A, B)

// Interactive content management
function showInteractiveForm(type) {
    // Hide all forms
    document.getElementById('multipleChoiceForm').style.display = 'none';
    document.getElementById('fillBlankForm').style.display = 'none';
    document.getElementById('trueFalseForm').style.display = 'none';
    
    // Show selected form
    if (type === 'multiple_choice') {
        document.getElementById('multipleChoiceForm').style.display = 'block';
        initializeMultipleChoice();
    } else if (type === 'fill_blank') {
        document.getElementById('fillBlankForm').style.display = 'block';
    } else if (type === 'true_false') {
        document.getElementById('trueFalseForm').style.display = 'block';
    }
}

function initializeMultipleChoice() {
    // Initialize with 2 default options
    const optionsContainer = document.getElementById('mcOptions');
    optionsContainer.innerHTML = '';
    optionCount = 0;
    
    for (let i = 0; i < 2; i++) {
        addOption();
    }
}

function addOption() {
    const optionsContainer = document.getElementById('mcOptions');
    const optionIndex = optionCount++;
    const optionLetter = String.fromCharCode(65 + optionIndex); // A, B, C, D...
    
    const optionHtml = `
        <div class="option-item mb-2" data-option="${optionIndex}">
            <div class="input-group">
                <div class="input-group-prepend">
                    <div class="input-group-text">
                        <input type="radio" name="correct_option" value="${optionIndex}">
                    </div>
                </div>
                <input type="text" class="form-control" name="option_${optionIndex}" placeholder="Option ${optionLetter}">
                <div class="input-group-append">
                    <button type="button" class="btn btn-outline-danger" onclick="removeOption(${optionIndex})">×</button>
                </div>
            </div>
            <small class="form-text text-muted">
                <input type="text" class="form-control form-control-sm mt-1" name="feedback_${optionIndex}" placeholder="Feedback for this option (optional)">
            </small>
        </div>
    `;
    
    optionsContainer.insertAdjacentHTML('beforeend', optionHtml);
}

function removeOption(optionIndex) {
    const optionElement = document.querySelector(`[data-option="${optionIndex}"]`);
    if (optionElement) {
        optionElement.remove();
    }
}

function initializeRichTextEditor() {
    const tinymceConfig = {
        selector: '.rich-text-editor',
        height: 400,
        menubar: false,
        plugins: [
            'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
            'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
            'insertdatetime', 'media', 'table', 'help', 'wordcount'
        ],
        toolbar: 'undo redo | blocks | ' +
            'bold italic forecolor | alignleft aligncenter ' +
            'alignright alignjustify | bullist numlist outdent indent | ' +
            'removeformat | help',
        content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, San Francisco, Segoe UI, Roboto, Helvetica Neue, sans-serif; font-size: 14px; }',
        branding: false,
        promotion: false,
        setup: function(editor) {
            editor.on('keyup', updateRichTextPreview);
            editor.on('change', updateRichTextPreview);
        }
    };
    tinymce.init(tinymceConfig);
}

function destroyRichTextEditor() {
    const editor = tinymce.get('richTextContent');
    if (editor) {
        editor.destroy();
    }
}

function updateRichTextPreview() {
    const editor = tinymce.get('richTextContent');
    if (editor) {
        const content = editor.getContent();
        document.getElementById('richTextPreview').innerHTML = content;
    }
}

let currentLessonId = null;
let categories = [];

// Get CSRF token from the form
function getCSRFToken(formId) {
    const form = document.getElementById(formId);
    if (form && form.csrf_token) {
        return form.csrf_token.value;
    }
    return null;
}

// Load lessons and categories on page load
document.addEventListener('DOMContentLoaded', function() {
    loadLessons();
    loadCategories();
});

// Load all lessons
async function loadLessons() {
    try {
        const response = await fetch('/api/admin/lessons');
        const lessons = await response.json();
        
        const tbody = document.querySelector('#lessonsTable tbody');
        tbody.innerHTML = '';
        
        lessons.forEach(lesson => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${lesson.id}</td>
                <td>${lesson.title}</td>
                <td><span class="badge badge-info">${lesson.category_name || 'No Category'}</span></td>
                <td><span class="badge ${lesson.lesson_type === 'free' ? 'badge-success' : 'badge-warning'}">${lesson.lesson_type}</span></td>
                <td>${lesson.difficulty_level || 'N/A'}</td>
                <td>${lesson.estimated_duration || 'N/A'} min</td>
                <td>${lesson.content_count}</td>
                <td><span class="badge ${lesson.is_published ? 'badge-success' : 'badge-secondary'}">${lesson.is_published ? 'Yes' : 'No'}</span></td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="manageContent(${lesson.id}, '${lesson.title}')">Content</button>
                    <button class="btn btn-sm btn-warning" onclick="editLesson(${lesson.id})">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteLesson(${lesson.id})">Delete</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    } catch (error) {
        console.error('Error loading lessons:', error);
        alert('Error loading lessons');
    }
}

// Load categories for dropdowns
async function loadCategories() {
    try {
        const response = await fetch('/api/admin/categories');
        categories = await response.json();
        
        const selects = ['lessonCategory', 'editLessonCategory'];
        selects.forEach(selectId => {
            const select = document.getElementById(selectId);
            // Clear existing options except the first one
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);
            });
        });
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

// Add new lesson
document.getElementById('addLessonForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    
    // Convert checkbox to boolean
    data.is_published = document.getElementById('lessonPublished').checked;
    
    // Convert empty strings to null for optional fields
    ['category_id', 'difficulty_level', 'estimated_duration', 'thumbnail_url', 'video_intro_url'].forEach(field => {
        if (data[field] === '') data[field] = null;
    });
    
    try {
        const response = await fetch('/api/admin/lessons/new', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken('addLessonForm')
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            closeModal('addLessonModal');
            this.reset();
            loadLessons();
            alert('Lesson added successfully!');
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (error) {
        console.error('Error adding lesson:', error);
        alert('Error adding lesson');
    }
});

// Edit lesson
async function editLesson(id) {
    try {
        const response = await fetch(`/api/admin/lessons/${id}`);
        const lesson = await response.json();
        
        document.getElementById('editLessonId').value = lesson.id;
        document.getElementById('editLessonTitle').value = lesson.title;
        document.getElementById('editLessonDescription').value = lesson.description || '';
        document.getElementById('editLessonType').value = lesson.lesson_type;
        document.getElementById('editLessonCategory').value = lesson.category_id || '';
        document.getElementById('editLessonDifficulty').value = lesson.difficulty_level || '';
        document.getElementById('editLessonDuration').value = lesson.estimated_duration || '';
        document.getElementById('editLessonOrder').value = lesson.order_index || 0;
        document.getElementById('editLessonThumbnail').value = lesson.thumbnail_url || '';
        document.getElementById('editLessonVideo').value = lesson.video_intro_url || '';
        document.getElementById('editLessonPublished').checked = lesson.is_published;
        
        openModal('editLessonModal');
    } catch (error) {
        console.error('Error loading lesson:', error);
        alert('Error loading lesson');
    }
}

// Update lesson
document.getElementById('editLessonForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    const id = data.id;
    delete data.id;
    
    // Convert checkbox to boolean
    data.is_published = document.getElementById('editLessonPublished').checked;
    
    // Convert empty strings to null for optional fields
    ['category_id', 'difficulty_level', 'estimated_duration', 'thumbnail_url', 'video_intro_url'].forEach(field => {
        if (data[field] === '') data[field] = null;
    });
    
    try {
        const response = await fetch(`/api/admin/lessons/${id}/edit`, {
            method: 'PUT',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken('editLessonForm')
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            closeModal('editLessonModal');
            loadLessons();
            alert('Lesson updated successfully!');
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (error) {
        console.error('Error updating lesson:', error);
        alert('Error updating lesson');
    }
});

// Delete lesson
async function deleteLesson(id) {
    if (!confirm('Are you sure you want to delete this lesson? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/lessons/${id}/delete`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCSRFToken('addLessonForm') // Can use any form's token
            }
        });
        
        if (response.ok) {
            loadLessons();
            alert('Lesson deleted successfully!');
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (error) {
        console.error('Error deleting lesson:', error);
        alert('Error deleting lesson');
    }
}

// Manage lesson content
function manageContent(lessonId, lessonTitle) {
    currentLessonId = lessonId;
    document.getElementById('contentLessonTitle').textContent = `Content for: ${lessonTitle}`;
    loadLessonContent(lessonId);
    openModal('lessonContentModal');
}

// Load lesson content
async function loadLessonContent(lessonId) {
    try {
        const response = await fetch(`/api/admin/lessons/${lessonId}/content`);
        const content = await response.json();
        
        const tbody = document.querySelector('#lessonContentTable tbody');
        tbody.innerHTML = '';
        
        content.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.order_index}</td>
                <td><span class="badge badge-primary">${item.content_type}</span></td>
                <td>${item.title || `${item.content_type} #${item.content_id || 'Custom'}`}</td>
                <td><span class="badge ${item.is_optional ? 'badge-warning' : 'badge-success'}">${item.is_optional ? 'Yes' : 'No'}</span></td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="removeContent(${lessonId}, ${item.id})">Remove</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    } catch (error) {
        console.error('Error loading lesson content:', error);
        alert('Error loading lesson content');
    }
}

// Remove content from lesson
async function removeContent(lessonId, contentId) {
    if (!confirm('Are you sure you want to remove this content from the lesson?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/lessons/${lessonId}/content/${contentId}/delete`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCSRFToken('addLessonForm') // Can use any form's token
            }
        });
        
        if (response.ok) {
            loadLessonContent(lessonId);
            loadLessons(); // Refresh main table to update content count
            alert('Content removed successfully!');
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (error) {
        console.error('Error removing content:', error);
        alert('Error removing content');
    }
}

// Enhanced Content Builder Variables
let selectedContentType = null;
let contentOptions = {};
let currentContentData = {};
let isFileUploading = false;

// Open enhanced add content modal
function openAddContentModal() {
    if (!currentLessonId) {
        alert('Please select a lesson first');
        return;
    }
    
    // Reset wizard state
    selectedContentType = null;
    currentContentData = {};
    
    // Show content type selection step
    showContentTypeStep();
    openModal('addContentModal');
}

// Content wizard step management
function showContentTypeStep() {
    document.getElementById('contentTypeStep').style.display = 'block';
    document.getElementById('contentConfigStep').style.display = 'none';
    document.getElementById('contentPreviewStep').style.display = 'none';
    
    // Update buttons
    document.getElementById('previewBtn').style.display = 'none';
    document.getElementById('saveContentBtn').style.display = 'none';
}

function showContentConfigStep() {
    document.getElementById('contentTypeStep').style.display = 'none';
    document.getElementById('contentConfigStep').style.display = 'block';
    document.getElementById('contentPreviewStep').style.display = 'none';
    
    // Update buttons
    document.getElementById('previewBtn').style.display = 'inline-block';
    document.getElementById('saveContentBtn').style.display = 'none';
}

function showContentPreviewStep() {
    document.getElementById('contentTypeStep').style.display = 'none';
    document.getElementById('contentConfigStep').style.display = 'none';
    document.getElementById('contentPreviewStep').style.display = 'block';
    
    // Update buttons
    document.getElementById('previewBtn').style.display = 'none';
    document.getElementById('saveContentBtn').style.display = 'inline-block';
}

// Content type selection
async function selectContentType(contentType) {
    selectedContentType = contentType;
    
    // Update step title
    const titles = {
        'kana': 'Configure Kana Content',
        'kanji': 'Configure Kanji Content',
        'vocabulary': 'Configure Vocabulary Content',
        'grammar': 'Configure Grammar Content',
        'text': 'Configure Text Content',
        'video': 'Configure Video Content',
        'audio': 'Configure Audio Content',
        'image': 'Configure Image Content',
        'interactive': 'Configure Interactive Content'
    };
    
    document.getElementById('configStepTitle').textContent = titles[contentType] || 'Configure Content';
    
    // Load content options for existing content types
    if (['kana', 'kanji', 'vocabulary', 'grammar'].includes(contentType)) {
        await loadContentOptions(contentType);
    }
    
    // Generate form fields
    generateContentConfigForm(contentType);
    
    // Show configuration step
    showContentConfigStep();
}

// Load available content options
async function loadContentOptions(contentType) {
    try {
        const response = await fetch(`/api/admin/content-options/${contentType}`);
        if (response.ok) {
            contentOptions[contentType] = await response.json();
        } else {
            contentOptions[contentType] = [];
        }
    } catch (error) {
        console.error(`Error loading ${contentType} options:`, error);
        contentOptions[contentType] = [];
    }
}

// Generate dynamic form fields based on content type
function generateContentConfigForm(contentType) {
    const fieldsContainer = document.getElementById('contentConfigFields');
    fieldsContainer.innerHTML = '';
    
    // Hide all special sections by default
    document.getElementById('richTextSection').style.display = 'none';
    document.getElementById('interactiveSection').style.display = 'none';
    destroyRichTextEditor();

    if (['kana', 'kanji', 'vocabulary', 'grammar'].includes(contentType)) {
        // Existing content selection
        const options = contentOptions[contentType] || [];
        
        fieldsContainer.innerHTML = `
            <div class="form-group">
                <label for="existingContentSelect">Select ${contentType.charAt(0).toUpperCase() + contentType.slice(1)} *</label>
                <select id="existingContentSelect" name="content_id" class="form-control" required>
                    <option value="">Choose ${contentType}...</option>
                    ${options.map(item => {
                        let displayText = '';
                        if (contentType === 'kana') displayText = `${item.character} (${item.romanization})`;
                        else if (contentType === 'kanji') displayText = `${item.character} - ${item.meaning}`;
                        else if (contentType === 'vocabulary') displayText = `${item.word} (${item.reading}) - ${item.meaning}`;
                        else if (contentType === 'grammar') displayText = item.title;
                        
                        return `<option value="${item.id}">${displayText}</option>`;
                    }).join('')}
                </select>
            </div>
            <div class="form-group">
                <label for="customTitle">Custom Title (optional)</label>
                <input type="text" id="customTitle" name="title" class="form-control" placeholder="Override default title">
            </div>
        `;
    } else if (contentType === 'text') {
        // Show rich text editor section
        document.getElementById('richTextSection').style.display = 'block';
        initializeRichTextEditor();
    } else if (contentType === 'interactive') {
        // Show interactive content section
        document.getElementById('interactiveSection').style.display = 'block';
    } else if (['video', 'audio', 'image'].includes(contentType)) {
        // URL-based media content
        const placeholders = {
            'video': 'https://www.youtube.com/watch?v=... or https://vimeo.com/...',
            'audio': 'https://example.com/audio.mp3',
            'image': 'https://example.com/image.jpg'
        };
        
        fieldsContainer.innerHTML = `
            <div class="form-group">
                <label for="mediaTitle">Title *</label>
                <input type="text" id="mediaTitle" name="title" class="form-control" required>
            </div>
            
            <!-- File Upload or URL Selection -->
            <div class="form-group">
                <label>Content Source</label>
                <div class="btn-group btn-group-toggle d-block mb-3" data-toggle="buttons">
                    <label class="btn btn-outline-primary active">
                        <input type="radio" name="contentSource" value="upload" checked onchange="toggleContentSource('upload')"> Upload File
                    </label>
                    <label class="btn btn-outline-primary">
                        <input type="radio" name="contentSource" value="url" onchange="toggleContentSource('url')"> Use URL
                    </label>
                </div>
            </div>
            
            <!-- File Upload Section -->
            <div id="fileUploadSection">
                <div class="form-group">
                    <label for="contentFile">Upload ${contentType.charAt(0).toUpperCase() + contentType.slice(1)} File *</label>
                    <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('contentFile').click()">
                        <input type="file" id="contentFile" name="file" accept="${getFileAcceptTypes(contentType)}" style="display: none;" onchange="handleFileSelect(event)">
                        <div class="upload-placeholder" id="uploadPlaceholder">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted"></i>
                            <p>Click to select ${contentType} file or drag and drop</p>
                            <small class="text-muted">Supported formats: <span id="supportedFormats">${getSupportedFormats(contentType)}</span></small>
                            <small class="text-muted d-block">Maximum file size: 100MB</small>
                        </div>
                        <div class="upload-progress" id="uploadProgress" style="display: none;">
                            <div class="progress mb-2">
                                <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted">Uploading... <span id="uploadPercent">0%</span></small>
                        </div>
                        <div class="upload-success" id="uploadSuccess" style="display: none;">
                            <i class="fas fa-check-circle fa-2x text-success"></i>
                            <p class="mb-1">File uploaded successfully!</p>
                            <small class="text-muted" id="uploadedFileName"></small>
                            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="clearUploadedFile()">
                                <i class="fas fa-times"></i> Remove
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- URL Section -->
            <div id="urlSection" style="display: none;">
                <div class="form-group">
                    <label for="mediaUrl">${contentType.charAt(0).toUpperCase() + contentType.slice(1)} URL *</label>
                    <input type="url" id="mediaUrl" name="media_url" class="form-control" placeholder="${placeholders[contentType]}">
                </div>
            </div>
            
            <div class="form-group">
                <label for="mediaDescription">Description (optional)</label>
                <textarea id="mediaDescription" name="content_text" class="form-control" rows="3" placeholder="Optional description or notes about this ${contentType}"></textarea>
            </div>
        `;
        
        // Initialize drag and drop
        setTimeout(() => {
            initializeDragAndDrop();
        }, 100);
    }
}

// Preview content before saving
async function previewContent() {
    const formData = new FormData(document.getElementById('contentConfigForm'));
    currentContentData = Object.fromEntries(formData.entries());
    currentContentData.content_type = selectedContentType;

    if (!validateContentData(currentContentData)) {
        return;
    }

    if (selectedContentType === 'text' || selectedContentType === 'interactive') {
        if (validateContentData(currentContentData)) {
            await generateContentPreview(currentContentData);
            showContentPreviewStep();
        }
        return;
    }

    const contentSource = document.querySelector('input[name="contentSource"]:checked')?.value;

    // If the source is URL, we don't need to handle file upload.
    // We can proceed with the old validation and preview logic.
    if (contentSource === 'url') {
        if (!validateContentData(currentContentData)) {
            return;
        }
        await generateContentPreview(currentContentData);
        showContentPreviewStep();
        return;
    }

    // If we are here, it means the source is 'upload'.
    const fileInput = document.getElementById('contentFile');
    const file = fileInput.files[0];
    const previewButton = document.getElementById('previewBtn');

    if (!file && !uploadedFileData) {
        alert('Please select a file first.');
        return;
    }

    // If a file is already uploaded, just run validation and preview.
    if (uploadedFileData) {
        const formData = new FormData(document.getElementById('contentConfigForm'));
        currentContentData = Object.fromEntries(formData.entries());
        currentContentData.content_type = selectedContentType;

        if (validateContentData(currentContentData)) {
            await generateContentPreview(currentContentData);
            showContentPreviewStep();
        }
        return;
    }

    previewButton.disabled = true;
    previewButton.textContent = 'Uploading...';

    try {
        const data = await uploadFile(file);
        console.log('Upload complete. Server data:', data);
        uploadedFileData = data;

        const formData = new FormData(document.getElementById('contentConfigForm'));
        currentContentData = Object.fromEntries(formData.entries());
        currentContentData.content_type = selectedContentType;

        if (validateContentData(currentContentData)) {
            await generateContentPreview(currentContentData);
            showContentPreviewStep();
        }
    } catch (error) {
        console.error('Upload failed:', error);
        alert(error.message);
        uploadedFileData = null;
    } finally {
        previewButton.disabled = false;
        previewButton.textContent = 'Preview';
    }
}

// Validate content data
function validateContentData(data) {
    console.log('Validating content data:', data);
    console.log('Current uploadedFileData:', uploadedFileData);
    
    if (['kana', 'kanji', 'vocabulary', 'grammar'].includes(data.content_type)) {
        if (!data.content_id) {
            alert(`Please select a ${data.content_type} item`);
            return false;
        }
    } else if (data.content_type === 'text') {
        const editor = tinymce.get('richTextContent');
        if (!data.title || !editor || !editor.getContent()) {
            alert('Please provide both title and content for text content');
            return false;
        }
        data.content_text = editor.getContent();
    } else if (data.content_type === 'interactive') {
        // Validation for interactive content
        if (!data.title || !data.interactive_type) {
            alert('Please provide a title and select an interactive type.');
            return false;
        }
        // Add more specific validation for each interactive type here
    } else if (['video', 'audio', 'image'].includes(data.content_type)) {
        if (!data.title) {
            alert(`Please provide a title for ${data.content_type} content`);
            return false;
        }
        
        const contentSource = document.querySelector('input[name="contentSource"]:checked')?.value;
        console.log('Content source:', contentSource);
        
        if (contentSource === 'upload') {
            if (!uploadedFileData || !uploadedFileData.filePath) {
                alert(`Please upload a ${data.content_type} file`);
                return false;
            }
        } else if (contentSource === 'url') {
            if (!data.media_url) {
                alert(`Please provide a URL for ${data.content_type} content`);
                return false;
            }
        } else {
            alert('Please select either file upload or URL option');
            return false;
        }
    }
    return true;
}

// Generate content preview
async function generateContentPreview(data) {
    const previewArea = document.getElementById('contentPreviewArea');
    let previewHTML = '';
    
    if (['kana', 'kanji', 'vocabulary', 'grammar'].includes(data.content_type)) {
        // Find the selected content item
        const options = contentOptions[data.content_type] || [];
        const selectedItem = options.find(item => item.id == data.content_id);
        
        if (selectedItem) {
            if (data.content_type === 'kana') {
                previewHTML = `
                    <h6>${data.title || `Kana: ${selectedItem.character}`}</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Character:</strong> ${selectedItem.character}<br>
                            <strong>Romanization:</strong> ${selectedItem.romanization}<br>
                            <strong>Type:</strong> ${selectedItem.type}
                        </div>
                    </div>
                `;
            } else if (data.content_type === 'kanji') {
                previewHTML = `
                    <h6>${data.title || `Kanji: ${selectedItem.character}`}</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Character:</strong> ${selectedItem.character}<br>
                            <strong>Meaning:</strong> ${selectedItem.meaning}<br>
                            <strong>Onyomi:</strong> ${selectedItem.onyomi || 'N/A'}<br>
                            <strong>Kunyomi:</strong> ${selectedItem.kunyomi || 'N/A'}
                        </div>
                        <div class="col-md-6">
                            <strong>JLPT Level:</strong> ${selectedItem.jlpt_level || 'N/A'}<br>
                            <strong>Stroke Count:</strong> ${selectedItem.stroke_count || 'N/A'}
                        </div>
                    </div>
                `;
            } else if (data.content_type === 'vocabulary') {
                previewHTML = `
                    <h6>${data.title || `Vocabulary: ${selectedItem.word}`}</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Word:</strong> ${selectedItem.word}<br>
                            <strong>Reading:</strong> ${selectedItem.reading}<br>
                            <strong>Meaning:</strong> ${selectedItem.meaning}
                        </div>
                        <div class="col-md-6">
                            <strong>JLPT Level:</strong> ${selectedItem.jlpt_level || 'N/A'}<br>
                            ${selectedItem.example_sentence_japanese ? `<strong>Example:</strong> ${selectedItem.example_sentence_japanese}` : ''}
                        </div>
                    </div>
                `;
            } else if (data.content_type === 'grammar') {
                previewHTML = `
                    <h6>${data.title || selectedItem.title}</h6>
                    <div class="row">
                        <div class="col-12">
                            <strong>Structure:</strong> ${selectedItem.structure || 'N/A'}<br>
                            <strong>JLPT Level:</strong> ${selectedItem.jlpt_level || 'N/A'}<br>
                            <strong>Explanation:</strong> ${selectedItem.explanation.substring(0, 200)}${selectedItem.explanation.length > 200 ? '...' : ''}
                        </div>
                    </div>
                `;
            }
        }
    } else if (data.content_type === 'text') {
        previewHTML = `
            <h6>${data.title}</h6>
            <div class="mt-2 rich-text-content">
                ${data.content_text}
            </div>
        `;
    } else if (data.content_type === 'interactive') {
        previewHTML = `<h6>${data.title}</h6><p>Interactive Content: ${data.interactive_type}</p>`;
    } else if (['video', 'audio', 'image'].includes(data.content_type)) {
        const contentSource = document.querySelector('input[name="contentSource"]:checked')?.value;
        
        if (contentSource === 'upload' && uploadedFileData) {
            previewHTML = `
                <h6>${data.title}</h6>
                <div class="mt-2">
                    <strong>File:</strong> ${uploadedFileData.original_filename} (${uploadedFileData.formatted_size})<br>
                    <strong>Type:</strong> ${uploadedFileData.file_type}<br>
                    ${uploadedFileData.dimensions ? `<strong>Dimensions:</strong> ${uploadedFileData.dimensions}<br>` : ''}
                    ${data.content_text ? `<strong>Description:</strong> ${data.content_text}` : ''}
                </div>
            `;
        } else if (contentSource === 'url' && data.media_url) {
            previewHTML = `
                <h6>${data.title}</h6>
                <div class="mt-2">
                    <strong>URL:</strong> <a href="${data.media_url}" target="_blank">${data.media_url}</a><br>
                    ${data.content_text ? `<strong>Description:</strong> ${data.content_text}` : ''}
                </div>
            `;
        } else {
            previewHTML = `
                <h6>${data.title}</h6>
                <div class="mt-2">
                    <div class="alert alert-warning">
                        <strong>Note:</strong> Please upload a file or provide a URL to complete the content setup.
                    </div>
                    ${data.content_text ? `<strong>Description:</strong> ${data.content_text}` : ''}
                </div>
            `;
        }
    }
    
    previewHTML += `
        <hr>
        <div class="row">
            <div class="col-md-6">
                <strong>Order Index:</strong> ${data.order_index || 0}
            </div>
            <div class="col-md-6">
                <strong>Optional:</strong> ${data.is_optional ? 'Yes' : 'No'}
            </div>
        </div>
    `;
    
    previewArea.innerHTML = previewHTML;
}

// Save content to lesson
async function saveContentToLesson() {
    if (!currentLessonId || !currentContentData) {
        alert('Missing lesson or content data');
        return;
    }
    
    try {
        console.log('Saving content data:', currentContentData);
        console.log('To lesson ID:', currentLessonId);
        console.log('Uploaded file data:', uploadedFileData);
        
        let endpoint = `/api/admin/lessons/${currentLessonId}/content/new`;
        let saveData = { ...currentContentData };
        
        if (selectedContentType === 'interactive') {
            endpoint = `/api/admin/lessons/${currentLessonId}/content/interactive`;
            const interactiveType = document.getElementById('interactiveType').value;
            saveData.interactive_type = interactiveType;
            saveData.is_interactive = true;

            if (interactiveType === 'multiple_choice') {
                const question = document.getElementById('mcQuestion').value;
                const explanation = document.getElementById('mcExplanation').value;
                const correctOption = document.querySelector('input[name="correct_option"]:checked')?.value;
                
                const options = [];
                const optionElements = document.querySelectorAll('.option-item');
                
                optionElements.forEach((element, index) => {
                    const optionInput = element.querySelector(`input[name^="option_"]`);
                    const feedbackInput = element.querySelector(`input[name^="feedback_"]`);
                    
                    if (optionInput && optionInput.value.trim()) {
                        options.push({
                            text: optionInput.value.trim(),
                            is_correct: correctOption === optionInput.name.split('_')[1],
                            feedback: feedbackInput ? feedbackInput.value.trim() : ''
                        });
                    }
                });
                
                saveData.question_text = question;
                saveData.explanation = explanation;
                saveData.options = options;
            } else if (interactiveType === 'fill_blank') {
                saveData.question_text = document.getElementById('fbQuestion').value;
                saveData.correct_answers = document.getElementById('fbAnswers').value;
                saveData.explanation = document.getElementById('fbExplanation').value;
            } else if (interactiveType === 'true_false') {
                const correctAnswer = document.querySelector('input[name="tf_answer"]:checked')?.value;
                saveData.question_text = document.getElementById('tfQuestion').value;
                saveData.correct_answer = correctAnswer === 'true';
                saveData.explanation = document.getElementById('tfExplanation').value;
            }
        } else if (['video', 'audio', 'image'].includes(selectedContentType)) {
            const contentSource = document.querySelector('input[name="contentSource"]:checked')?.value;
            
            if (contentSource === 'upload' && uploadedFileData) {
                // Use file upload endpoint
                endpoint = `/api/admin/lessons/${currentLessonId}/content/file`;
                saveData = {
                    content_type: selectedContentType,
                    title: currentContentData.title,
                    description: currentContentData.content_text || '',
                file_path: uploadedFileData.filePath,
                    file_size: uploadedFileData.file_size,
                    file_type: uploadedFileData.file_type,
                    original_filename: uploadedFileData.original_filename,
                    order_index: currentContentData.order_index || 0,
                    is_optional: currentContentData.is_optional || false
                };
            } else if (contentSource === 'url') {
                // Use regular content endpoint with URL
                if (!currentContentData.media_url) {
                    alert('Please provide a URL for the content');
                    return;
                }
            } else {
                alert('Please either upload a file or provide a URL');
                return;
            }
        }
        
        const headers = { 
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCSRFToken('contentConfigForm')
        };
        
        console.log('Using endpoint:', endpoint);
        console.log('Sending data:', saveData);
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(saveData)
        });
        
        console.log('Response status:', response.status);
        
        if (response.ok) {
            const result = await response.json();
            console.log('Success result:', result);
            closeModal('addContentModal');
            loadLessonContent(currentLessonId);
            loadLessons(); // Refresh main table to update content count
            alert('Content added to lesson successfully!');
            
            // Clear uploaded file data
            uploadedFileData = null;
        } else {
            const errorText = await response.text();
            console.error('Error response:', errorText);
            try {
                const error = JSON.parse(errorText);
                alert('Error: ' + (error.error || 'Unknown error'));
            } catch (e) {
                alert('Error: ' + errorText);
            }
        }
    } catch (error) {
        console.error('Error saving content:', error);
        alert('Error saving content to lesson: ' + error.message);
    }
}

// File Upload Variables
let uploadedFileData = null;

// File upload helper functions
function getFileAcceptTypes(contentType) {
    const acceptTypes = {
        'image': 'image/*',
        'video': 'video/*',
        'audio': 'audio/*'
    };
    return acceptTypes[contentType] || '*/*';
}

function getSupportedFormats(contentType) {
    const formats = {
        'image': 'JPG, PNG, GIF, WebP',
        'video': 'MP4, WebM, OGG, AVI, MOV',
        'audio': 'MP3, WAV, OGG, AAC, M4A'
    };
    return formats[contentType] || 'All formats';
}

// Toggle between file upload and URL input
function toggleContentSource(source) {
    const fileSection = document.getElementById('fileUploadSection');
    const urlSection = document.getElementById('urlSection');
    
    if (source === 'upload') {
        fileSection.style.display = 'block';
        urlSection.style.display = 'none';
        // Clear URL field
        const urlInput = document.getElementById('mediaUrl');
        if (urlInput) urlInput.value = '';
    } else {
        fileSection.style.display = 'none';
        urlSection.style.display = 'block';
        // Clear uploaded file
        clearUploadedFile();
    }
}

// Initialize drag and drop functionality
function initializeDragAndDrop() {
    const uploadArea = document.getElementById('fileUploadArea');
    if (!uploadArea) return;
    
    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    // Highlight drop area when item is dragged over it
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, unhighlight, false);
    });
    
    // Handle dropped files
    uploadArea.addEventListener('drop', handleDrop, false);
}

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

function highlight(e) {
    const uploadArea = document.getElementById('fileUploadArea');
    uploadArea.classList.add('drag-over');
}

function unhighlight(e) {
    const uploadArea = document.getElementById('fileUploadArea');
    uploadArea.classList.remove('drag-over');
}

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    
    if (files.length > 0) {
        const fileInput = document.getElementById('contentFile');
        fileInput.files = files;
        handleFileSelect({ target: fileInput });
    }
}

// Handle file selection
function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validate file type
    const fileType = selectedContentType;
    if (!validateFileType(file, fileType)) {
        alert(`Invalid file type. Please select a ${fileType} file.`);
        clearFileInput();
        return;
    }
    
    // Validate file size (100MB limit)
    const maxSize = 100 * 1024 * 1024; // 100MB
    if (file.size > maxSize) {
        alert('File size exceeds 100MB limit. Please choose a smaller file.');
        clearFileInput();
        return;
    }
    
    // Upload file
    uploadFile(file);
}

// Validate file type
function validateFileType(file, expectedType) {
    const fileExtension = file.name.split('.').pop().toLowerCase();
    const validExtensions = {
        'image': ['jpg', 'jpeg', 'png', 'gif', 'webp'],
        'video': ['mp4', 'webm', 'ogg', 'avi', 'mov'],
        'audio': ['mp3', 'wav', 'ogg', 'aac', 'm4a']
    };
    
    return validExtensions[expectedType] && validExtensions[expectedType].includes(fileExtension);
}

// Upload file to server
function uploadFile(file) {
    return new Promise((resolve, reject) => {
        if (!currentLessonId) {
            reject(new Error('No lesson selected'));
            return;
        }

        isFileUploading = true;
        showUploadProgress();

        const formData = new FormData();
        formData.append('file', file);
        formData.append('lesson_id', currentLessonId);

        const xhr = new XMLHttpRequest();

        xhr.upload.addEventListener('progress', function (e) {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                updateUploadProgress(percentComplete);
            }
        });

        xhr.onload = function () {
            isFileUploading = false;
            if (xhr.status >= 200 && xhr.status < 300) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.success) {
                        showUploadSuccess(response);
                        resolve(response);
                    } else {
                        showUploadError(response.error || 'Upload failed');
                        reject(new Error(response.error || 'Upload failed'));
                    }
                } catch (e) {
                    showUploadError('Failed to parse server response.');
                    reject(new Error('Failed to parse server response.'));
                }
            } else {
                try {
                    const errorResponse = JSON.parse(xhr.responseText);
                    showUploadError(errorResponse.error || `Server responded with status: ${xhr.status}`);
                    reject(new Error(errorResponse.error || `Server responded with status: ${xhr.status}`));
                } catch (e) {
                    showUploadError(`Server responded with status: ${xhr.status}`);
                    reject(new Error(`Server responded with status: ${xhr.status}`));
                }
            }
        };

        xhr.onerror = function () {
            isFileUploading = false;
            showUploadError('Network error during upload');
            reject(new Error('Network error occurred during upload.'));
        };

        xhr.open('POST', '/api/admin/upload-file', true);
        xhr.send(formData);
    });
}

// Show upload progress
function showUploadProgress() {
    document.getElementById('uploadPlaceholder').style.display = 'none';
    document.getElementById('uploadProgress').style.display = 'block';
    document.getElementById('uploadSuccess').style.display = 'none';
}

// Update upload progress
function updateUploadProgress(percent) {
    const progressBar = document.getElementById('progressBar');
    const percentText = document.getElementById('uploadPercent');
    
    progressBar.style.width = percent + '%';
    percentText.textContent = Math.round(percent) + '%';
}

// Show upload success
function showUploadSuccess(fileData) {
    document.getElementById('uploadPlaceholder').style.display = 'none';
    document.getElementById('uploadProgress').style.display = 'none';
    document.getElementById('uploadSuccess').style.display = 'block';
    
    const fileName = document.getElementById('uploadedFileName');
    const originalFilename = fileData.original_filename || fileData.fileName;
    const formattedSize = fileData.formatted_size || '';
    fileName.textContent = `${originalFilename} ${formattedSize ? `(${formattedSize})` : ''}`;
}

// Show upload error
function showUploadError(message) {
    document.getElementById('uploadPlaceholder').style.display = 'block';
    document.getElementById('uploadProgress').style.display = 'none';
    document.getElementById('uploadSuccess').style.display = 'none';
    
    alert('Upload failed: ' + message);
    clearFileInput();
}

// Clear uploaded file
function clearUploadedFile() {
    uploadedFileData = null;
    clearFileInput();
    
    document.getElementById('uploadPlaceholder').style.display = 'block';
    document.getElementById('uploadProgress').style.display = 'none';
    document.getElementById('uploadSuccess').style.display = 'none';
}

// Clear file input
function clearFileInput() {
    const fileInput = document.getElementById('contentFile');
    if (fileInput) {
        fileInput.value = '';
    }
}


// Modal functions
function openModal(modalId) {
    document.getElementById(modalId).style.display = "block";
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = "none";
    
    // Clear uploaded file data when closing modal
    if (modalId === 'addContentModal') {
        uploadedFileData = null;
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target === modal) {
            modal.style.display = "none";
            
            // Clear uploaded file data when closing modal
            if (modal.id === 'addContentModal') {
                uploadedFileData = null;
            }
        }
    });
}
</script>
{% endblock %}

</final_file_content>

IMPORTANT: For any future changes to this file, use the final_file_content shown above as your reference. This content reflects the current state of the file, including any auto-formatting (e.g., if you used single quotes but the formatter converted them to double quotes). Always base your SEARCH/REPLACE operations on this final version to ensure accuracy.

<environment_details>
# VSCode Visible Files
app/templates/admin/manage_lessons.html

# VSCode Open Tabs
Documentation.md
app/__init__.py
app/utils.py
requirements.txt
app/models.py
app/routes.py
run.py
app/templates/admin/manage_lessons.html
migrate_file_fields.py

# Current Time
6/21/2025, 9:38:42 PM (Europe/Zurich, UTC+2:00)

# Context Window Usage
280,150 / 1,048.576K tokens used (27%)

# Current Mode
ACT MODE
</environment_details>

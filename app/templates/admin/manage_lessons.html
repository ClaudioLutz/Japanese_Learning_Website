{% extends "admin/base_admin.html" %}

{% block title %}Manage Lessons - Admin Panel{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Manage Lessons</h2>
                <button type="button" class="btn btn-primary" onclick="openModal('addLessonModal')">
                    <i class="fas fa-plus"></i> Add New Lesson
                </button>
            </div>

            <!-- Lessons Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">All Lessons</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped" id="lessonsTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Type</th>
                                    <th>Difficulty</th>
                                    <th>Duration</th>
                                    <th>Content Items</th>
                                    <th>Published</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Content will be loaded via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Lesson Modal -->
<div id="addLessonModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h4>Add New Lesson</h4>
            <span class="close" onclick="closeModal('addLessonModal')">&times;</span>
        </div>
        <form id="addLessonForm">
            <div class="modal-body">
                <div class="form-group">
                    <label for="lessonTitle">Title *</label>
                    <input type="text" id="lessonTitle" name="title" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="lessonDescription">Description</label>
                    <textarea id="lessonDescription" name="description" class="form-control" rows="3"></textarea>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="lessonType">Type *</label>
                            <select id="lessonType" name="lesson_type" class="form-control" required>
                                <option value="">Select Type</option>
                                <option value="free">Free</option>
                                <option value="premium">Premium</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="lessonCategory">Category</label>
                            <select id="lessonCategory" name="category_id" class="form-control">
                                <option value="">Select Category</option>
                                <!-- Categories will be loaded via JavaScript -->
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="lessonDifficulty">Difficulty (1-5)</label>
                            <input type="number" id="lessonDifficulty" name="difficulty_level" class="form-control" min="1" max="5">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="lessonDuration">Duration (minutes)</label>
                            <input type="number" id="lessonDuration" name="estimated_duration" class="form-control" min="1">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="lessonOrder">Order Index</label>
                            <input type="number" id="lessonOrder" name="order_index" class="form-control" min="0" value="0">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="lessonThumbnail">Thumbnail URL</label>
                    <input type="url" id="lessonThumbnail" name="thumbnail_url" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="lessonVideo">Video Intro URL</label>
                    <input type="url" id="lessonVideo" name="video_intro_url" class="form-control">
                </div>
                
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" id="lessonPublished" name="is_published" class="form-check-input">
                        <label for="lessonPublished" class="form-check-label">Published</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addLessonModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Lesson</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Lesson Modal -->
<div id="editLessonModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h4>Edit Lesson</h4>
            <span class="close" onclick="closeModal('editLessonModal')">&times;</span>
        </div>
        <form id="editLessonForm">
            <input type="hidden" id="editLessonId" name="id">
            <div class="modal-body">
                <div class="form-group">
                    <label for="editLessonTitle">Title *</label>
                    <input type="text" id="editLessonTitle" name="title" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="editLessonDescription">Description</label>
                    <textarea id="editLessonDescription" name="description" class="form-control" rows="3"></textarea>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="editLessonType">Type *</label>
                            <select id="editLessonType" name="lesson_type" class="form-control" required>
                                <option value="">Select Type</option>
                                <option value="free">Free</option>
                                <option value="premium">Premium</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="editLessonCategory">Category</label>
                            <select id="editLessonCategory" name="category_id" class="form-control">
                                <option value="">Select Category</option>
                                <!-- Categories will be loaded via JavaScript -->
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="editLessonDifficulty">Difficulty (1-5)</label>
                            <input type="number" id="editLessonDifficulty" name="difficulty_level" class="form-control" min="1" max="5">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="editLessonDuration">Duration (minutes)</label>
                            <input type="number" id="editLessonDuration" name="estimated_duration" class="form-control" min="1">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="editLessonOrder">Order Index</label>
                            <input type="number" id="editLessonOrder" name="order_index" class="form-control" min="0">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editLessonThumbnail">Thumbnail URL</label>
                    <input type="url" id="editLessonThumbnail" name="thumbnail_url" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="editLessonVideo">Video Intro URL</label>
                    <input type="url" id="editLessonVideo" name="video_intro_url" class="form-control">
                </div>
                
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" id="editLessonPublished" name="is_published" class="form-check-input">
                        <label for="editLessonPublished" class="form-check-label">Published</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('editLessonModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Lesson</button>
            </div>
        </form>
    </div>
</div>

<!-- Lesson Content Modal -->
<div id="lessonContentModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h4>Manage Lesson Content</h4>
            <span class="close" onclick="closeModal('lessonContentModal')">&times;</span>
        </div>
        <div class="modal-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 id="contentLessonTitle">Lesson Content</h5>
                <button type="button" class="btn btn-sm btn-primary" onclick="openAddContentModal()">
                    <i class="fas fa-plus"></i> Add Content
                </button>
            </div>
            
            <div class="table-responsive">
                <table class="table table-sm" id="lessonContentTable">
                    <thead>
                        <tr>
                            <th>Order</th>
                            <th>Type</th>
                            <th>Title</th>
                            <th>Optional</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Content will be loaded via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('lessonContentModal')">Close</button>
        </div>
    </div>
</div>

<!-- Enhanced Add Content Wizard Modal -->
<div id="addContentModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h4 id="addContentModalTitle">Add Content to Lesson</h4>
            <span class="close" onclick="closeModal('addContentModal')">&times;</span>
        </div>
        <div class="modal-body">
            <!-- Step 1: Content Type Selection -->
            <div id="contentTypeStep" class="content-step">
                <h5 class="mb-4">Choose Content Type:</h5>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="content-type-card" onclick="selectContentType('kana')">
                            <div class="card h-100 text-center">
                                <div class="card-body">
                                    <div class="content-type-icon">üìù</div>
                                    <h6 class="card-title">Kana</h6>
                                    <p class="card-text small">Hiragana & Katakana characters</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="content-type-card" onclick="selectContentType('kanji')">
                            <div class="card h-100 text-center">
                                <div class="card-body">
                                    <div class="content-type-icon">üî§</div>
                                    <h6 class="card-title">Kanji</h6>
                                    <p class="card-text small">Chinese characters</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="content-type-card" onclick="selectContentType('vocabulary')">
                            <div class="card h-100 text-center">
                                <div class="card-body">
                                    <div class="content-type-icon">üìö</div>
                                    <h6 class="card-title">Vocabulary</h6>
                                    <p class="card-text small">Words & phrases</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="content-type-card" onclick="selectContentType('grammar')">
                            <div class="card h-100 text-center">
                                <div class="card-body">
                                    <div class="content-type-icon">üìñ</div>
                                    <h6 class="card-title">Grammar</h6>
                                    <p class="card-text small">Grammar rules & patterns</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="content-type-card" onclick="selectContentType('text')">
                            <div class="card h-100 text-center">
                                <div class="card-body">
                                    <div class="content-type-icon">üìÑ</div>
                                    <h6 class="card-title">Text</h6>
                                    <p class="card-text small">Custom text content</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="content-type-card" onclick="selectContentType('video')">
                            <div class="card h-100 text-center">
                                <div class="card-body">
                                    <div class="content-type-icon">üé•</div>
                                    <h6 class="card-title">Video</h6>
                                    <p class="card-text small">Video content (URL)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="content-type-card" onclick="selectContentType('audio')">
                            <div class="card h-100 text-center">
                                <div class="card-body">
                                    <div class="content-type-icon">üéµ</div>
                                    <h6 class="card-title">Audio</h6>
                                    <p class="card-text small">Audio content (URL)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="content-type-card" onclick="selectContentType('image')">
                            <div class="card h-100 text-center">
                                <div class="card-body">
                                    <div class="content-type-icon">üñºÔ∏è</div>
                                    <h6 class="card-title">Image</h6>
                                    <p class="card-text small">Image content (URL)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Content Configuration -->
            <div id="contentConfigStep" class="content-step" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 id="configStepTitle">Configure Content</h5>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="showContentTypeStep()">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                </div>
                
                <form id="contentConfigForm">
                    <div id="contentConfigFields">
                        <!-- Dynamic form fields will be inserted here -->
                    </div>
                    
                    <!-- Common fields for all content types -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="contentOrder">Order Index</label>
                                <input type="number" id="contentOrder" name="order_index" class="form-control" min="0" value="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <div class="form-check mt-4">
                                    <input type="checkbox" id="contentOptional" name="is_optional" class="form-check-input">
                                    <label for="contentOptional" class="form-check-label">Optional Content</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Step 3: Preview & Confirm -->
            <div id="contentPreviewStep" class="content-step" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5>Preview & Confirm</h5>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="showContentConfigStep()">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Content Preview</h6>
                    </div>
                    <div class="card-body" id="contentPreviewArea">
                        <!-- Preview content will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('addContentModal')">Cancel</button>
            <button type="button" id="nextStepBtn" class="btn btn-primary" onclick="nextStep()" style="display: none;">Next</button>
            <button type="button" id="previewBtn" class="btn btn-primary" onclick="previewContent()" style="display: none;">Preview</button>
            <button type="button" id="saveContentBtn" class="btn btn-success" onclick="saveContentToLesson()" style="display: none;">Add to Lesson</button>
        </div>
    </div>
</div>

<style>
.content-step {
    min-height: 400px;
}

.content-type-card {
    cursor: pointer;
    transition: transform 0.2s;
}

.content-type-card:hover {
    transform: translateY(-2px);
}

.content-type-card .card {
    border: 2px solid #e9ecef;
    transition: border-color 0.2s;
}

.content-type-card:hover .card {
    border-color: #007bff;
}

.content-type-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.form-group {
    margin-bottom: 1rem;
}

#contentPreviewArea {
    max-height: 300px;
    overflow-y: auto;
}
</style>

<script>
let currentLessonId = null;
let categories = [];

// Get CSRF token from meta tag or cookie
function getCSRFToken() {
    // Try to get from meta tag first
    const metaToken = document.querySelector('meta[name=csrf-token]');
    if (metaToken) {
        return metaToken.getAttribute('content');
    }
    
    // Try to get from cookie
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrf_token') {
            return decodeURIComponent(value);
        }
    }
    
    return null;
}

// Load lessons and categories on page load
document.addEventListener('DOMContentLoaded', function() {
    loadLessons();
    loadCategories();
});

// Load all lessons
async function loadLessons() {
    try {
        const response = await fetch('/api/admin/lessons');
        const lessons = await response.json();
        
        const tbody = document.querySelector('#lessonsTable tbody');
        tbody.innerHTML = '';
        
        lessons.forEach(lesson => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${lesson.id}</td>
                <td>${lesson.title}</td>
                <td><span class="badge badge-info">${lesson.category_name || 'No Category'}</span></td>
                <td><span class="badge ${lesson.lesson_type === 'free' ? 'badge-success' : 'badge-warning'}">${lesson.lesson_type}</span></td>
                <td>${lesson.difficulty_level || 'N/A'}</td>
                <td>${lesson.estimated_duration || 'N/A'} min</td>
                <td>${lesson.content_count}</td>
                <td><span class="badge ${lesson.is_published ? 'badge-success' : 'badge-secondary'}">${lesson.is_published ? 'Yes' : 'No'}</span></td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="manageContent(${lesson.id}, '${lesson.title}')">Content</button>
                    <button class="btn btn-sm btn-warning" onclick="editLesson(${lesson.id})">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteLesson(${lesson.id})">Delete</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    } catch (error) {
        console.error('Error loading lessons:', error);
        alert('Error loading lessons');
    }
}

// Load categories for dropdowns
async function loadCategories() {
    try {
        const response = await fetch('/api/admin/categories');
        categories = await response.json();
        
        const selects = ['lessonCategory', 'editLessonCategory'];
        selects.forEach(selectId => {
            const select = document.getElementById(selectId);
            // Clear existing options except the first one
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);
            });
        });
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

// Add new lesson
document.getElementById('addLessonForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    
    // Convert checkbox to boolean
    data.is_published = document.getElementById('lessonPublished').checked;
    
    // Convert empty strings to null for optional fields
    ['category_id', 'difficulty_level', 'estimated_duration', 'thumbnail_url', 'video_intro_url'].forEach(field => {
        if (data[field] === '') data[field] = null;
    });
    
    try {
        const response = await fetch('/api/admin/lessons/new', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            closeModal('addLessonModal');
            this.reset();
            loadLessons();
            alert('Lesson added successfully!');
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (error) {
        console.error('Error adding lesson:', error);
        alert('Error adding lesson');
    }
});

// Edit lesson
async function editLesson(id) {
    try {
        const response = await fetch(`/api/admin/lessons/${id}`);
        const lesson = await response.json();
        
        document.getElementById('editLessonId').value = lesson.id;
        document.getElementById('editLessonTitle').value = lesson.title;
        document.getElementById('editLessonDescription').value = lesson.description || '';
        document.getElementById('editLessonType').value = lesson.lesson_type;
        document.getElementById('editLessonCategory').value = lesson.category_id || '';
        document.getElementById('editLessonDifficulty').value = lesson.difficulty_level || '';
        document.getElementById('editLessonDuration').value = lesson.estimated_duration || '';
        document.getElementById('editLessonOrder').value = lesson.order_index || 0;
        document.getElementById('editLessonThumbnail').value = lesson.thumbnail_url || '';
        document.getElementById('editLessonVideo').value = lesson.video_intro_url || '';
        document.getElementById('editLessonPublished').checked = lesson.is_published;
        
        openModal('editLessonModal');
    } catch (error) {
        console.error('Error loading lesson:', error);
        alert('Error loading lesson');
    }
}

// Update lesson
document.getElementById('editLessonForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    const id = data.id;
    delete data.id;
    
    // Convert checkbox to boolean
    data.is_published = document.getElementById('editLessonPublished').checked;
    
    // Convert empty strings to null for optional fields
    ['category_id', 'difficulty_level', 'estimated_duration', 'thumbnail_url', 'video_intro_url'].forEach(field => {
        if (data[field] === '') data[field] = null;
    });
    
    try {
        const response = await fetch(`/api/admin/lessons/${id}/edit`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            closeModal('editLessonModal');
            loadLessons();
            alert('Lesson updated successfully!');
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (error) {
        console.error('Error updating lesson:', error);
        alert('Error updating lesson');
    }
});

// Delete lesson
async function deleteLesson(id) {
    if (!confirm('Are you sure you want to delete this lesson? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/lessons/${id}/delete`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadLessons();
            alert('Lesson deleted successfully!');
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (error) {
        console.error('Error deleting lesson:', error);
        alert('Error deleting lesson');
    }
}

// Manage lesson content
function manageContent(lessonId, lessonTitle) {
    currentLessonId = lessonId;
    document.getElementById('contentLessonTitle').textContent = `Content for: ${lessonTitle}`;
    loadLessonContent(lessonId);
    openModal('lessonContentModal');
}

// Load lesson content
async function loadLessonContent(lessonId) {
    try {
        const response = await fetch(`/api/admin/lessons/${lessonId}/content`);
        const content = await response.json();
        
        const tbody = document.querySelector('#lessonContentTable tbody');
        tbody.innerHTML = '';
        
        content.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.order_index}</td>
                <td><span class="badge badge-primary">${item.content_type}</span></td>
                <td>${item.title || `${item.content_type} #${item.content_id || 'Custom'}`}</td>
                <td><span class="badge ${item.is_optional ? 'badge-warning' : 'badge-success'}">${item.is_optional ? 'Yes' : 'No'}</span></td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="removeContent(${lessonId}, ${item.id})">Remove</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    } catch (error) {
        console.error('Error loading lesson content:', error);
        alert('Error loading lesson content');
    }
}

// Remove content from lesson
async function removeContent(lessonId, contentId) {
    if (!confirm('Are you sure you want to remove this content from the lesson?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/lessons/${lessonId}/content/${contentId}/delete`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadLessonContent(lessonId);
            loadLessons(); // Refresh main table to update content count
            alert('Content removed successfully!');
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (error) {
        console.error('Error removing content:', error);
        alert('Error removing content');
    }
}

// Enhanced Content Builder Variables
let selectedContentType = null;
let contentOptions = {};
let currentContentData = {};

// Open enhanced add content modal
function openAddContentModal() {
    if (!currentLessonId) {
        alert('Please select a lesson first');
        return;
    }
    
    // Reset wizard state
    selectedContentType = null;
    currentContentData = {};
    
    // Show content type selection step
    showContentTypeStep();
    openModal('addContentModal');
}

// Content wizard step management
function showContentTypeStep() {
    document.getElementById('contentTypeStep').style.display = 'block';
    document.getElementById('contentConfigStep').style.display = 'none';
    document.getElementById('contentPreviewStep').style.display = 'none';
    
    // Update buttons
    document.getElementById('nextStepBtn').style.display = 'none';
    document.getElementById('previewBtn').style.display = 'none';
    document.getElementById('saveContentBtn').style.display = 'none';
}

function showContentConfigStep() {
    document.getElementById('contentTypeStep').style.display = 'none';
    document.getElementById('contentConfigStep').style.display = 'block';
    document.getElementById('contentPreviewStep').style.display = 'none';
    
    // Update buttons
    document.getElementById('nextStepBtn').style.display = 'none';
    document.getElementById('previewBtn').style.display = 'inline-block';
    document.getElementById('saveContentBtn').style.display = 'none';
}

function showContentPreviewStep() {
    document.getElementById('contentTypeStep').style.display = 'none';
    document.getElementById('contentConfigStep').style.display = 'none';
    document.getElementById('contentPreviewStep').style.display = 'block';
    
    // Update buttons
    document.getElementById('nextStepBtn').style.display = 'none';
    document.getElementById('previewBtn').style.display = 'none';
    document.getElementById('saveContentBtn').style.display = 'inline-block';
}

// Content type selection
async function selectContentType(contentType) {
    selectedContentType = contentType;
    
    // Update step title
    const titles = {
        'kana': 'Configure Kana Content',
        'kanji': 'Configure Kanji Content',
        'vocabulary': 'Configure Vocabulary Content',
        'grammar': 'Configure Grammar Content',
        'text': 'Configure Text Content',
        'video': 'Configure Video Content',
        'audio': 'Configure Audio Content',
        'image': 'Configure Image Content'
    };
    
    document.getElementById('configStepTitle').textContent = titles[contentType] || 'Configure Content';
    
    // Load content options for existing content types
    if (['kana', 'kanji', 'vocabulary', 'grammar'].includes(contentType)) {
        await loadContentOptions(contentType);
    }
    
    // Generate form fields
    generateContentConfigForm(contentType);
    
    // Show configuration step
    showContentConfigStep();
}

// Load available content options
async function loadContentOptions(contentType) {
    try {
        const response = await fetch(`/api/admin/content-options/${contentType}`);
        if (response.ok) {
            contentOptions[contentType] = await response.json();
        } else {
            contentOptions[contentType] = [];
        }
    } catch (error) {
        console.error(`Error loading ${contentType} options:`, error);
        contentOptions[contentType] = [];
    }
}

// Generate dynamic form fields based on content type
function generateContentConfigForm(contentType) {
    const fieldsContainer = document.getElementById('contentConfigFields');
    fieldsContainer.innerHTML = '';
    
    if (['kana', 'kanji', 'vocabulary', 'grammar'].includes(contentType)) {
        // Existing content selection
        const options = contentOptions[contentType] || [];
        
        fieldsContainer.innerHTML = `
            <div class="form-group">
                <label for="existingContentSelect">Select ${contentType.charAt(0).toUpperCase() + contentType.slice(1)} *</label>
                <select id="existingContentSelect" name="content_id" class="form-control" required>
                    <option value="">Choose ${contentType}...</option>
                    ${options.map(item => {
                        let displayText = '';
                        if (contentType === 'kana') displayText = `${item.character} (${item.romanization})`;
                        else if (contentType === 'kanji') displayText = `${item.character} - ${item.meaning}`;
                        else if (contentType === 'vocabulary') displayText = `${item.word} (${item.reading}) - ${item.meaning}`;
                        else if (contentType === 'grammar') displayText = item.title;
                        
                        return `<option value="${item.id}">${displayText}</option>`;
                    }).join('')}
                </select>
            </div>
            <div class="form-group">
                <label for="customTitle">Custom Title (optional)</label>
                <input type="text" id="customTitle" name="title" class="form-control" placeholder="Override default title">
            </div>
        `;
    } else if (contentType === 'text') {
        // Custom text content
        fieldsContainer.innerHTML = `
            <div class="form-group">
                <label for="textTitle">Title *</label>
                <input type="text" id="textTitle" name="title" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="textContent">Content *</label>
                <textarea id="textContent" name="content_text" class="form-control" rows="6" required placeholder="Enter your text content here..."></textarea>
            </div>
        `;
    } else if (['video', 'audio', 'image'].includes(contentType)) {
        // URL-based media content
        const placeholders = {
            'video': 'https://www.youtube.com/watch?v=... or https://vimeo.com/...',
            'audio': 'https://example.com/audio.mp3',
            'image': 'https://example.com/image.jpg'
        };
        
        fieldsContainer.innerHTML = `
            <div class="form-group">
                <label for="mediaTitle">Title *</label>
                <input type="text" id="mediaTitle" name="title" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="mediaUrl">${contentType.charAt(0).toUpperCase() + contentType.slice(1)} URL *</label>
                <input type="url" id="mediaUrl" name="media_url" class="form-control" required placeholder="${placeholders[contentType]}">
            </div>
            <div class="form-group">
                <label for="mediaDescription">Description (optional)</label>
                <textarea id="mediaDescription" name="content_text" class="form-control" rows="3" placeholder="Optional description or notes about this ${contentType}"></textarea>
            </div>
        `;
    }
}

// Preview content before saving
async function previewContent() {
    // Collect form data
    const formData = new FormData(document.getElementById('contentConfigForm'));
    currentContentData = Object.fromEntries(formData.entries());
    currentContentData.content_type = selectedContentType;
    
    // Validate required fields
    if (!validateContentData(currentContentData)) {
        return;
    }
    
    // Generate preview
    await generateContentPreview(currentContentData);
    
    // Show preview step
    showContentPreviewStep();
}

// Validate content data
function validateContentData(data) {
    if (['kana', 'kanji', 'vocabulary', 'grammar'].includes(data.content_type)) {
        if (!data.content_id) {
            alert(`Please select a ${data.content_type} item`);
            return false;
        }
    } else if (data.content_type === 'text') {
        if (!data.title || !data.content_text) {
            alert('Please provide both title and content for text content');
            return false;
        }
    } else if (['video', 'audio', 'image'].includes(data.content_type)) {
        if (!data.title || !data.media_url) {
            alert(`Please provide both title and URL for ${data.content_type} content`);
            return false;
        }
    }
    return true;
}

// Generate content preview
async function generateContentPreview(data) {
    const previewArea = document.getElementById('contentPreviewArea');
    let previewHTML = '';
    
    if (['kana', 'kanji', 'vocabulary', 'grammar'].includes(data.content_type)) {
        // Find the selected content item
        const options = contentOptions[data.content_type] || [];
        const selectedItem = options.find(item => item.id == data.content_id);
        
        if (selectedItem) {
            if (data.content_type === 'kana') {
                previewHTML = `
                    <h6>${data.title || `Kana: ${selectedItem.character}`}</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Character:</strong> ${selectedItem.character}<br>
                            <strong>Romanization:</strong> ${selectedItem.romanization}<br>
                            <strong>Type:</strong> ${selectedItem.type}
                        </div>
                    </div>
                `;
            } else if (data.content_type === 'kanji') {
                previewHTML = `
                    <h6>${data.title || `Kanji: ${selectedItem.character}`}</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Character:</strong> ${selectedItem.character}<br>
                            <strong>Meaning:</strong> ${selectedItem.meaning}<br>
                            <strong>Onyomi:</strong> ${selectedItem.onyomi || 'N/A'}<br>
                            <strong>Kunyomi:</strong> ${selectedItem.kunyomi || 'N/A'}
                        </div>
                        <div class="col-md-6">
                            <strong>JLPT Level:</strong> ${selectedItem.jlpt_level || 'N/A'}<br>
                            <strong>Stroke Count:</strong> ${selectedItem.stroke_count || 'N/A'}
                        </div>
                    </div>
                `;
            } else if (data.content_type === 'vocabulary') {
                previewHTML = `
                    <h6>${data.title || `Vocabulary: ${selectedItem.word}`}</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Word:</strong> ${selectedItem.word}<br>
                            <strong>Reading:</strong> ${selectedItem.reading}<br>
                            <strong>Meaning:</strong> ${selectedItem.meaning}
                        </div>
                        <div class="col-md-6">
                            <strong>JLPT Level:</strong> ${selectedItem.jlpt_level || 'N/A'}<br>
                            ${selectedItem.example_sentence_japanese ? `<strong>Example:</strong> ${selectedItem.example_sentence_japanese}` : ''}
                        </div>
                    </div>
                `;
            } else if (data.content_type === 'grammar') {
                previewHTML = `
                    <h6>${data.title || selectedItem.title}</h6>
                    <div class="row">
                        <div class="col-12">
                            <strong>Structure:</strong> ${selectedItem.structure || 'N/A'}<br>
                            <strong>JLPT Level:</strong> ${selectedItem.jlpt_level || 'N/A'}<br>
                            <strong>Explanation:</strong> ${selectedItem.explanation.substring(0, 200)}${selectedItem.explanation.length > 200 ? '...' : ''}
                        </div>
                    </div>
                `;
            }
        }
    } else if (data.content_type === 'text') {
        previewHTML = `
            <h6>${data.title}</h6>
            <div class="mt-2">
                ${data.content_text.replace(/\n/g, '<br>')}
            </div>
        `;
    } else if (['video', 'audio', 'image'].includes(data.content_type)) {
        previewHTML = `
            <h6>${data.title}</h6>
            <div class="mt-2">
                <strong>URL:</strong> <a href="${data.media_url}" target="_blank">${data.media_url}</a><br>
                ${data.content_text ? `<strong>Description:</strong> ${data.content_text}` : ''}
            </div>
        `;
    }
    
    previewHTML += `
        <hr>
        <div class="row">
            <div class="col-md-6">
                <strong>Order Index:</strong> ${data.order_index || 0}
            </div>
            <div class="col-md-6">
                <strong>Optional:</strong> ${data.is_optional ? 'Yes' : 'No'}
            </div>
        </div>
    `;
    
    previewArea.innerHTML = previewHTML;
}

// Save content to lesson
async function saveContentToLesson() {
    if (!currentLessonId || !currentContentData) {
        alert('Missing lesson or content data');
        return;
    }
    
    try {
        console.log('Saving content data:', currentContentData);
        console.log('To lesson ID:', currentLessonId);
        
        const headers = { 
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        };
        
        // Add CSRF token if available
        const csrfToken = getCSRFToken();
        if (csrfToken) {
            headers['X-CSRFToken'] = csrfToken;
        }
        
        const response = await fetch(`/api/admin/lessons/${currentLessonId}/content/new`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(currentContentData)
        });
        
        console.log('Response status:', response.status);
        
        if (response.ok) {
            const result = await response.json();
            console.log('Success result:', result);
            closeModal('addContentModal');
            loadLessonContent(currentLessonId);
            loadLessons(); // Refresh main table to update content count
            alert('Content added to lesson successfully!');
        } else {
            const errorText = await response.text();
            console.error('Error response:', errorText);
            try {
                const error = JSON.parse(errorText);
                alert('Error: ' + (error.error || 'Unknown error'));
            } catch (e) {
                alert('Error: ' + errorText);
            }
        }
    } catch (error) {
        console.error('Error saving content:', error);
        alert('Error saving content to lesson: ' + error.message);
    }
}

// Modal functions
function openModal(modalId) {
    document.getElementById(modalId).style.display = "block";
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = "none";
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target === modal) {
            modal.style.display = "none";
        }
    });
}
</script>
{% endblock %}

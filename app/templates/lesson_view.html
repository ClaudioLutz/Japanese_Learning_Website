{% extends "base.html" %}

{% block title %}{{ lesson.title }} - Japanese Learning{% endblock %}

{% block content %}
<style>
    /* Enhanced Navigation Styles */
    .lesson-navigation-top {
        background: linear-gradient(135deg, #4a90e2 0%, #50e3c2 100%);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 12px rgba(74, 144, 226, 0.2);
    }
    
    .lesson-navigation-bottom {
        background-color: #ffffff;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 1rem 1.5rem;
        margin-top: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .page-counter {
        font-size: 1.1rem;
        font-weight: 600;
    }
    
    .nav-progress-bar {
        height: 8px;
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        overflow: hidden;
        margin: 0.5rem 0;
    }
    
    .nav-progress-fill {
        height: 100%;
        background-color: white;
        border-radius: 4px;
        transition: width 0.3s ease;
    }
    
    .nav-btn {
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        border-radius: 8px;
        transition: all 0.2s ease;
        border: none;
        min-width: 120px;
    }
    
    .nav-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .nav-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .nav-btn-primary {
        background-color: #4a90e2;
        color: white;
    }
    
    .nav-btn-secondary {
        background-color: #6c757d;
        color: white;
    }
    
    /* Page Overview Menu */
    .page-overview {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        margin-bottom: 1.5rem;
    }
    
    .page-overview-header {
        padding: 1rem 1.5rem;
        background-color: white;
        border-bottom: 1px solid #e9ecef;
        border-radius: 12px 12px 0 0;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    
    .page-overview-header:hover {
        background-color: #f8f9fa;
    }
    
    .page-overview-content {
        padding: 1rem;
        display: none;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .page-overview-content.show {
        display: block;
    }
    
    .page-menu-item {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        margin-bottom: 0.5rem;
        background-color: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        color: inherit;
    }
    
    .page-menu-item:hover {
        background-color: #4a90e2;
        color: white;
        transform: translateX(5px);
        text-decoration: none;
    }
    
    .page-menu-item.active {
        background-color: #50e3c2;
        color: white;
        border-color: #50e3c2;
    }
    
    .page-menu-number {
        background-color: #4a90e2;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin-right: 1rem;
        font-size: 0.9rem;
    }
    
    .page-menu-item.active .page-menu-number {
        background-color: white;
        color: #50e3c2;
    }
    
    .page-menu-item:hover .page-menu-number {
        background-color: white;
        color: #4a90e2;
    }
    
    /* Enhanced Carousel Controls */
    #lessonCarousel .carousel-control-prev,
    #lessonCarousel .carousel-control-next {
        width: 8%;
        top: 20%;
        height: 60%;
    }
    
    #lessonCarousel .carousel-control-prev-icon,
    #lessonCarousel .carousel-control-next-icon {
        background-color: rgba(74, 144, 226, 0.8);
        border-radius: 50%;
        padding: 25px;
        transition: all 0.3s ease;
    }
    
    #lessonCarousel .carousel-control-prev:hover .carousel-control-prev-icon,
    #lessonCarousel .carousel-control-next:hover .carousel-control-next-icon {
        background-color: #4a90e2;
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
    }
    
    #lessonCarousel .carousel-item .page-container {
        min-height: 400px;
    }
    
    /* Enhanced indicators */
    #lessonCarousel .carousel-indicators {
        position: static;
        margin-top: 1rem;
        margin-bottom: 1rem;
    }
    
    #lessonCarousel .carousel-indicators [data-bs-target] {
        background-color: #a0a0a0;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin: 0 5px;
        transition: all 0.3s ease;
    }
    
    #lessonCarousel .carousel-indicators .active {
        background-color: #4a90e2;
        transform: scale(1.2);
    }
    
    #lessonCarousel .carousel-indicators [data-bs-target]:hover {
        background-color: #50e3c2;
        transform: scale(1.1);
    }
    
    /* Keyboard navigation indicator */
    .keyboard-hint {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .keyboard-hint.show {
        opacity: 1;
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
        .lesson-navigation-top,
        .lesson-navigation-bottom {
            padding: 0.75rem 1rem;
        }
        
        .nav-btn {
            min-width: 100px;
            padding: 0.5rem 1rem;
        }
        
        .page-counter {
            font-size: 1rem;
        }
        
        #lessonCarousel .carousel-control-prev,
        #lessonCarousel .carousel-control-next {
            width: 12%;
        }
        
        .keyboard-hint {
            display: none;
        }
    }
</style>
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card lesson-header-card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h1 class="card-title">{{ lesson.title }}</h1>
                            <p class="card-text">{{ lesson.description or 'No description available.' }}</p>
                            
                            <div class="d-flex flex-wrap gap-2 mb-3">
                                <span class="badge {{ 'bg-success' if lesson.lesson_type == 'free' else 'bg-warning' }}">
                                    {{ lesson.lesson_type | title }}
                                </span>
                                {% if lesson.category %}
                                <span class="badge bg-info">{{ lesson.category.name }}</span>
                                {% endif %}
                                {% if lesson.difficulty_level %}
                                <span class="badge bg-secondary">Difficulty: {{ lesson.difficulty_level }}/5</span>
                                {% endif %}
                                {% if lesson.estimated_duration %}
                                <span class="badge bg-dark">{{ lesson.estimated_duration }} minutes</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            {% if lesson.thumbnail_url %}
                            <img src="{{ lesson.thumbnail_url }}" class="img-fluid rounded" alt="{{ lesson.title }}">
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if current_user.is_authenticated %}
                        {% if progress %}
                        <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">Your Progress</h6>
                                <span class="text-muted">{{ progress.progress_percentage }}%</span>
                            </div>
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: {{ progress.progress_percentage }}%" 
                                     aria-valuenow="{{ progress.progress_percentage }}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                            <div class="row text-center">
                                {% if progress.time_spent %}
                                <div class="col">
                                    <small class="text-muted">Time Spent: {{ progress.time_spent }} minutes</small>
                                </div>
                                {% endif %}
                                {% if progress.started_at %}
                                <div class="col">
                                    <small class="text-muted">Started: {{ progress.started_at.strftime('%Y-%m-%d') }}</small>
                                </div>
                                {% endif %}
                                {% if progress.completed_at %}
                                <div class="col">
                                    <small class="text-success">Completed: {{ progress.completed_at.strftime('%Y-%m-%d') }}</small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="mt-3">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> 
                                <strong>Guest Access:</strong> You're viewing this lesson as a guest. 
                                <a href="{{ url_for('routes.register') }}" class="alert-link">Create an account</a> 
                                or <a href="{{ url_for('routes.login') }}" class="alert-link">login</a> 
                                to track your progress and access quizzes.
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            {% if lesson.video_intro_url %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Introduction Video</h5>
                </div>
                <div class="card-body">
                    <div class="ratio ratio-16x9">
                        <iframe src="{{ lesson.video_intro_url | to_embed_url }}" allowfullscreen></iframe>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Enhanced Top Navigation -->
            {% if lesson.pages and lesson.pages|length > 1 %}
            <div class="lesson-navigation-top">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <button class="nav-btn nav-btn-secondary" id="prevPageTop" onclick="previousPage()" disabled>
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="page-counter" id="pageCounter">Page 1 of {{ lesson.pages|length }}</div>
                        <div class="nav-progress-bar">
                            <div class="nav-progress-fill" id="navProgressFill" style="width: {{ (100 / lesson.pages|length)|round(1) }}%"></div>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="nav-btn nav-btn-primary" id="nextPageTop" onclick="nextPage()">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Page Overview Menu -->
            <div class="page-overview">
                <div class="page-overview-header" onclick="togglePageOverview()">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-list"></i> Page Overview</h6>
                        <i class="fas fa-chevron-down" id="overviewToggleIcon"></i>
                    </div>
                </div>
                <div class="page-overview-content" id="pageOverviewContent">
                    {% for page in lesson.pages %}
                    <div class="page-menu-item" onclick="goToPage({{ loop.index0 }})" data-page="{{ loop.index0 }}">
                        <div class="page-menu-number">{{ loop.index }}</div>
                        <div>
                            <div class="fw-bold">{{ page.metadata.title or 'Page ' ~ loop.index }}</div>
                            {% if page.metadata.description %}
                            <small class="text-muted">{{ page.metadata.description }}</small>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="card lesson-content-card">
                <div class="card-header">
                    <h5 class="mb-0">Lesson Content</h5>
                </div>
                <div class="card-body">
                    {% if lesson.pages %}
                        <div id="lessonCarousel" class="carousel slide" data-bs-interval="false">
                            <div class="carousel-inner">
                                {% for page in lesson.pages %}
                                <div class="carousel-item {% if loop.first %}active{% endif %}">
                                    <div class="page-container p-3">
                                        <h4 class="page-title mb-2 text-center">
                                            {{ page.metadata.title or 'Page ' ~ loop.index }}
                                        </h4>
                                        {% if page.metadata.description %}
                                        <p class="page-description text-center text-muted mb-4">{{ page.metadata.description }}</p>
                                        {% endif %}
                                        
                                        {% for content in page.content %}
                                        <div class="content-item mb-4 p-3 border rounded bg-white shadow-sm" data-content-id="{{ content.id }}">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h6 class="mb-0">
                                                    {{ content.title or (content.content_type + ' #' + (content.content_id | string if content.content_id else 'Custom')) }}
                                                    {% if content.is_optional %}
                                                    <span class="badge bg-warning ms-2">Optional</span>
                                                    {% endif %}
                                                </h6>
                                                {% if current_user.is_authenticated %}
                                                <button class="btn btn-sm btn-outline-success mark-complete-btn" 
                                                        onclick="markContentComplete({{ content.id }})"
                                                        {% if progress and progress.get_content_progress().get(content.id | string) %}
                                                        style="display: none;"
                                                        {% endif %}>
                                                    Mark Complete
                                                </button>
                                                <span class="badge bg-success completed-badge" 
                                                      {% if not (progress and progress.get_content_progress().get(content.id | string)) %}
                                                      style="display: none;"
                                                      {% endif %}>
                                                    ✓ Completed
                                                </span>
                                                {% endif %}
                                            </div>
                                            
                                            <div class="content-body">
                                                {% if content.content_type in ['kana', 'kanji', 'vocabulary', 'grammar'] %}
                                                    {% set content_data = content.get_content_data() %}
                                                    {% if content_data %}
                                                        <div class="flip-card">
                                                            <button class="card-scene" 
                                                                    aria-label="Flip card for {% if content.content_type in ['kana', 'kanji'] %}{{ content_data.character }}{% elif content.content_type == 'vocabulary' %}{{ content_data.word }}{% else %}{{ content_data.title }}{% endif %} to see details"
                                                                    tabindex="0">
                                                                <div class="card-flipper">
                                                                    <div class="card-face card-face--front">
                                                                        {% if content.content_type == 'kana' %}
                                                                            <span class="kana-char">{{ content_data.character }}</span>
                                                                        {% elif content.content_type == 'kanji' %}
                                                                            <span class="kana-char">{{ content_data.character }}</span>
                                                                        {% elif content.content_type == 'vocabulary' %}
                                                                            <div class="vocab-front">
                                                                                <div class="vocab-word">{{ content_data.word }}</div>
                                                                                <div class="vocab-reading">{{ content_data.reading }}</div>
                                                                            </div>
                                                                        {% elif content.content_type == 'grammar' %}
                                                                            <div class="grammar-front">
                                                                                <div class="grammar-title">{{ content_data.title }}</div>
                                                                                {% if content_data.structure %}
                                                                                <div class="grammar-structure">{{ content_data.structure }}</div>
                                                                                {% endif %}
                                                                            </div>
                                                                        {% endif %}
                                                                        <div class="flip-hint">Click to flip</div>
                                                                    </div>
                                                                    
                                                                    <div class="card-face card-face--back">
                                                                        <div class="details">
                                                                            {% if content.content_type == 'kana' %}
                                                                                <p><strong>Romanization:</strong> {{ content_data.romanization }}</p>
                                                                                <p><strong>Type:</strong> {{ content_data.type | title }}</p>
                                                                                {% if content_data.stroke_order_info %}
                                                                                <p><strong>Stroke Order:</strong> {{ content_data.stroke_order_info }}</p>
                                                                                {% endif %}
                                                                            {% elif content.content_type == 'kanji' %}
                                                                                <p><strong>Meaning:</strong> {{ content_data.meaning }}</p>
                                                                                {% if content_data.onyomi %}
                                                                                <p><strong>On'yomi:</strong> {{ content_data.onyomi }}</p>
                                                                                {% endif %}
                                                                                {% if content_data.kunyomi %}
                                                                                <p><strong>Kun'yomi:</strong> {{ content_data.kunyomi }}</p>
                                                                                {% endif %}
                                                                                {% if content_data.jlpt_level %}
                                                                                <p><strong>JLPT Level:</strong> N{{ content_data.jlpt_level }}</p>
                                                                                {% endif %}
                                                                            {% elif content.content_type == 'vocabulary' %}
                                                                                <p><strong>Meaning:</strong> {{ content_data.meaning }}</p>
                                                                                {% if content_data.example_sentence_japanese %}
                                                                                <p><strong>Example:</strong><br>{{ content_data.example_sentence_japanese }}</p>
                                                                                {% if content_data.example_sentence_english %}
                                                                                <p><strong>Translation:</strong><br>{{ content_data.example_sentence_english }}</p>
                                                                                {% endif %}
                                                                                {% endif %}
                                                                            {% elif content.content_type == 'grammar' %}
                                                                                <p><strong>Explanation:</strong><br>{{ content_data.explanation }}</p>
                                                                                {% if content_data.example_sentences %}
                                                                                <p><strong>Examples:</strong><br>{{ content_data.example_sentences }}</p>
                                                                                {% endif %}
                                                                            {% endif %}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </button>
                                                        </div>
                                                    {% else %}
                                                        <p class="text-muted">Content not found.</p>
                                                    {% endif %}
                                                {% else %}
                                                    {% if content.content_type == 'text' %}
                                                    <div class="text-content-container">
                                                        {% if content.title %}
                                                        <div class="content-header mb-3">
                                                            <h4 class="content-title">{{ content.title }}</h4>
                                                            {% if content.content_text and 'information_slide' in content.content_text %}
                                                            <span class="badge bg-info">Information Slide</span>
                                                            {% endif %}
                                                        </div>
                                                        {% endif %}
                                                        
                                                        <div class="rich-text-content">
                                                            {{ content.content_text | safe }}
                                                        </div>
                                                    </div>
                                                    {% else %}
                                                        {% if content.content_text %}
                                                        <div class="mb-3">{{ content.content_text | safe }}</div>
                                                        {% endif %}
                                                        
                                                        {% if content.content_type == 'image' %}
                                                            {% if content.file_path %}
                                                            <img src="{{ url_for('static', filename='uploads/' + content.file_path) }}" class="img-fluid rounded" alt="{{ content.title }}" style="max-width: 100%; height: auto;">
                                                            {% elif content.media_url %}
                                                            <img src="{{ content.media_url }}" class="img-fluid rounded" alt="{{ content.title }}" style="max-width: 100%; height: auto;">
                                                            {% endif %}
                                                        {% elif content.media_url %}
                                                            {% if content.content_type == 'video' %}
                                                            <div class="ratio ratio-16x9">
                                                                <iframe src="{{ content.media_url | to_embed_url }}" allowfullscreen></iframe>
                                                            </div>
                                                            {% elif content.content_type == 'audio' %}
                                                            <audio controls class="w-100">
                                                                <source src="{{ content.media_url }}" type="audio/mpeg">
                                                                Your browser does not support the audio element.
                                                            </audio>
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endif %}
                                                {% endif %}
                                                {% if content.is_interactive %}
                                                {% if current_user.is_authenticated %}
                                                <div class="interactive-content-container" data-content-id="{{ content.id }}">
                                                    {% for question in content.quiz_questions %}
                                                    {% set user_answer = user_quiz_answers.get(question.id) %}
                                                    <div class="quiz-question mb-4" data-question-id="{{ question.id }}" data-question-type="{{ question.question_type }}">
                                                        <div class="question-header mb-3">
                                                            <h5>{{ question.question_text | safe }}</h5>
                                                            {% if question.points > 1 %}
                                                            <span class="badge bg-primary">{{ question.points }} points</span>
                                                            {% endif %}
                                                            {% if user_answer and user_answer.is_correct %}
                                                            <span class="badge bg-success ms-2">✓ Completed</span>
                                                            {% endif %}
                                                        </div>
                                                        
                                                        {% if question.question_type == 'multiple_choice' %}
                                                        <div class="multiple-choice-options">
                                                            {% for option in question.options | sort(attribute='order_index') %}
                                                            <div class="form-check mb-2">
                                                                <input class="form-check-input" type="radio" name="question_{{ question.id }}" 
                                                                       id="option_{{ option.id }}" value="{{ option.id }}"
                                                                       {% if user_answer and user_answer.selected_option_id == option.id %}checked{% endif %}
                                                                       {% if user_answer and user_answer.is_correct %}disabled{% endif %}>
                                                                <label class="form-check-label" for="option_{{ option.id }}">
                                                                    {{ option.option_text }}
                                                                </label>
                                                            </div>
                                                            {% endfor %}
                                                        </div>
                                                        
                                                        {% elif question.question_type == 'fill_blank' %}
                                                        <div class="fill-blank-input">
                                                            <div class="question-text mb-3">
                                                                {% if user_answer and user_answer.text_answer %}
                                                                {% set input_html = '<input type="text" class="form-control d-inline-block" style="width: 200px;" id="blank_' ~ question.id ~ '" value="' ~ user_answer.text_answer ~ '"' ~ (' disabled' if user_answer.is_correct else '') ~ '>' %}
                                                                {{ question.question_text | replace('___', input_html) | safe }}
                                                                {% else %}
                                                                {% set input_html = '<input type="text" class="form-control d-inline-block" style="width: 200px;" id="blank_' ~ question.id ~ '">' %}
                                                                {{ question.question_text | replace('___', input_html) | safe }}
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        
                                                        {% elif question.question_type == 'true_false' %}
                                                        <div class="true-false-options">
                                                            {% for option in question.options | sort(attribute='order_index') %}
                                                            <div class="form-check mb-2">
                                                                <input class="form-check-input" type="radio" name="question_{{ question.id }}" 
                                                                       id="option_{{ option.id }}" value="{{ option.id }}"
                                                                       {% if user_answer and user_answer.selected_option_id == option.id %}checked{% endif %}
                                                                       {% if user_answer and user_answer.is_correct %}disabled{% endif %}>
                                                                <label class="form-check-label" for="option_{{ option.id }}">
                                                                    {{ option.option_text }}
                                                                </label>
                                                            </div>
                                                            {% endfor %}
                                                        </div>
                                                        
                                        {% elif question.question_type == 'matching' %}
                                        <div class="matching-quiz">
                                            {% set prompts = question.options | map(attribute='option_text') | list %}
                                            {% set answers = question.options | map(attribute='feedback') | list %}
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <div class="matching-instructions mb-3">
                                                        <p class="text-muted">Match each Japanese term with its correct English meaning:</p>
                                                    </div>
                                                    <div class="matching-pairs">
                                                        {% for option in question.options | sort(attribute='order_index') %}
                                                        <div class="matching-pair mb-3 p-3 border rounded">
                                                            <div class="row align-items-center">
                                                                <div class="col-md-6">
                                                                    <div class="matching-prompt">
                                                                        <strong>{{ option.option_text }}</strong>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <select class="form-select matching-select" 
                                                                            data-prompt="{{ option.option_text }}" 
                                                                            data-correct-answer="{{ option.feedback }}"
                                                                            data-question-id="{{ question.id }}">
                                                                        <option value="" selected disabled>Choose...</option>
                                                                        {% for answer_option in question.options | sort(attribute='order_index') %}
                                                                        <option value="{{ answer_option.feedback }}">{{ answer_option.feedback }}</option>
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                                        {% endif %}
                                                        
                                                        <div class="question-actions mt-3">
                                                            <button class="btn btn-primary" onclick="submitQuizAnswer('{{ lesson.id }}', '{{ question.id }}')">
                                                                Submit Answer
                                                            </button>
                                                            <div class="quiz-feedback mt-2" id="feedback_{{ question.id }}" 
                                                                 {% if user_answer %}style="display: block;"{% else %}style="display: none;"{% endif %}>
                                                                {% if user_answer %}
                                                                    {% if user_answer.is_correct %}
                                                                    <div class="alert alert-success">✓ Correct!</div>
                                                                    {% else %}
                                                                    <div class="alert alert-danger">✗ Incorrect</div>
                                                                    {% endif %}
                                                                    {% if question.explanation %}
                                                                    <div class="alert alert-info">{{ question.explanation }}</div>
                                                                    {% endif %}
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="quiz-attempts mt-2">
                                                            <small class="text-muted">
                                                                Attempts remaining: <span id="attempts_{{ question.id }}">
                                                                    {% if user_answer %}
                                                                        {% if content.max_attempts %}
                                                                            {{ content.max_attempts - user_answer.attempts }}
                                                                        {% else %}
                                                                            Unlimited
                                                                        {% endif %}
                                                                    {% else %}
                                                                        {{ content.max_attempts or 'Unlimited' }}
                                                                    {% endif %}
                                                                </span>
                                                            </small>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                {% else %}
                                                <div class="alert alert-warning">
                                                    <i class="fas fa-lock"></i> 
                                                    <strong>Quiz Available:</strong> This lesson contains interactive quizzes. 
                                                    <a href="{{ url_for('routes.login') }}" class="alert-link">Login</a> 
                                                    to access the quiz features.
                                                </div>
                                                {% endif %}
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <h5 class="text-muted">No content available yet</h5>
                            <p class="text-muted">This lesson is still being prepared. Please check back later.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Enhanced Bottom Navigation -->
            {% if lesson.pages and lesson.pages|length > 1 %}
            <div class="lesson-navigation-bottom">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <button class="nav-btn nav-btn-secondary" id="prevPageBottom" onclick="previousPage()" disabled>
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="page-counter" id="pageCounterBottom">Page 1 of {{ lesson.pages|length }}</div>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="nav-btn nav-btn-primary" id="nextPageBottom" onclick="nextPage()">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="mt-4 d-flex justify-content-between">
                <a href="{{ url_for('routes.lessons') }}" class="btn btn-outline-secondary">
                    ← Back to Lessons
                </a>
                
                <div>
                    {% if progress and progress.progress_percentage == 100 %}
                    <span class="text-success me-3">
                        <i class="fas fa-check-circle"></i> Lesson Completed!
                    </span>
                    {% endif %}

                    {% if progress and (progress.progress_percentage > 0 or progress.is_completed) %}
                    <form action="{{ url_for('routes.reset_lesson_progress', lesson_id=lesson.id) }}" method="POST" class="d-inline">
                        {{ form.hidden_tag() }}
                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to reset your progress for this lesson?');">
                            <i class="fas fa-undo"></i> Reset Progress
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let startTime = Date.now();

// 3D Flip Card JavaScript - Scalable Implementation
document.addEventListener('DOMContentLoaded', () => {
    // Select all card components on the page
    const cards = document.querySelectorAll('.card-scene');

    cards.forEach(card => {
        // Set the initial accessibility state for screen readers
        card.setAttribute('aria-pressed', 'false');

        // Find the flipper element within this specific card
        const flipper = card.querySelector('.card-flipper');

        // Add click event listener to the card (the button)
        card.addEventListener('click', () => {
            // Check if the card is currently flipped
            const isFlipped = flipper.classList.contains('is-flipped');

            // Toggle the flip state
            flipper.classList.toggle('is-flipped');

            // Update the ARIA attribute to match the new state
            card.setAttribute('aria-pressed', !isFlipped);
        });

        // Add keyboard support (Enter and Space keys)
        card.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault(); // Prevent page scroll on Space
                card.click(); // Trigger the click event
            }
        });
    });

    // Shuffle matching quiz options
    const matchingSelects = document.querySelectorAll('.matching-select');
    matchingSelects.forEach(select => {
        const options = Array.from(select.querySelectorAll('option')).slice(1); // Skip the first "Choose..." option
        const shuffled = shuffleArray(options);
        
        // Remove existing options (except first)
        while (select.children.length > 1) {
            select.removeChild(select.lastChild);
        }
        
        // Add shuffled options back
        shuffled.forEach(option => {
            select.appendChild(option);
        });
    });
});

// Helper function to shuffle array
function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

async function submitQuizAnswer(lessonId, questionId) {
    const questionElement = document.querySelector(`[data-question-id="${questionId}"]`);
    const questionType = questionElement.dataset.questionType;
    
    let answerData = {};
    
    if (questionType === 'multiple_choice' || questionType === 'true_false') {
        const selectedOption = questionElement.querySelector(`input[name="question_${questionId}"]:checked`);
        if (!selectedOption) {
            alert('Please select an answer');
            return;
        }
        answerData.selected_option_id = selectedOption.value;
        console.log('Selected option ID:', answerData.selected_option_id);
    } else if (questionType === 'fill_blank') {
        const textInput = questionElement.querySelector(`#blank_${questionId}`);
        if (!textInput || !textInput.value.trim()) {
            alert('Please provide an answer');
            return;
        }
        answerData.text_answer = textInput.value.trim();
    } else if (questionType === 'matching') {
        const selects = questionElement.querySelectorAll('.matching-select');
        let allSelected = true;
        answerData.pairs = [];
        
        selects.forEach(select => {
            if (!select.value || select.value === '') {
                allSelected = false;
            } else {
                answerData.pairs.push({
                    prompt: select.dataset.prompt,
                    answer: select.value,
                    correct_answer: select.dataset.correctAnswer
                });
            }
        });

        if (!allSelected) {
            alert('Please match all items.');
            return;
        }
    }
    
    try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const response = await fetch('/api/lessons/' + lessonId + '/quiz/' + questionId + '/answer', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(answerData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showQuizFeedback(questionId, result);
            updateAttempts(questionId, result.attempts_remaining);
            
            if (result.is_correct) {
                markContentComplete(questionElement.closest('[data-content-id]').dataset.contentId);
            }
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        console.error('Error submitting answer:', error);
        alert('Error submitting answer');
    }
}

function showQuizFeedback(questionId, result) {
    const feedbackElement = document.getElementById(`feedback_${questionId}`);
    
    let feedbackHtml = '';
    if (result.is_correct) {
        feedbackHtml = '<div class="alert alert-success">✓ Correct!</div>';
    } else {
        feedbackHtml = '<div class="alert alert-danger">✗ Incorrect</div>';
    }
    
    if (result.explanation) {
        feedbackHtml += `<div class="alert alert-info">${result.explanation}</div>`;
    }
    
    if (result.option_feedback) {
        feedbackHtml += `<div class="alert alert-warning">${result.option_feedback}</div>`;
    }
    
    feedbackElement.innerHTML = feedbackHtml;
    feedbackElement.style.display = 'block';
    
    // Disable question if correct or no attempts remaining
    if (result.is_correct || result.attempts_remaining === 0) {
        const questionElement = document.querySelector(`[data-question-id="${questionId}"]`);
        const inputs = questionElement.querySelectorAll('input');
        const button = questionElement.querySelector('button');
        
        inputs.forEach(input => input.disabled = true);
        if(button) button.disabled = true;
    }
}

function updateAttempts(questionId, attemptsRemaining) {
    const attemptsElement = document.getElementById(`attempts_${questionId}`);
    if (attemptsElement) {
        attemptsElement.textContent = attemptsRemaining;
    }
}

async function markContentComplete(contentId) {
    try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const lessonId = '{{ lesson.id }}';
        const response = await fetch('/api/lessons/' + lessonId + '/progress', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ 
                content_id: contentId,
                time_spent: Math.floor((Date.now() - startTime) / 60000) // minutes
            })
        });
        
        if (response.ok) {
            const progress = await response.json();
            
            // Update UI
            const contentItem = document.querySelector(`[data-content-id="${contentId}"]`);
            const markBtn = contentItem.querySelector('.mark-complete-btn');
            const completedBadge = contentItem.querySelector('.completed-badge');
            
            markBtn.style.display = 'none';
            completedBadge.style.display = 'inline';
            
            // Update progress bar
            const progressBar = document.querySelector('.progress-bar');
            if (progressBar) {
                progressBar.style.width = progress.progress_percentage + '%';
                progressBar.setAttribute('aria-valuenow', progress.progress_percentage);
                
                // Update percentage text
                const percentageText = document.querySelector('.progress').previousElementSibling.querySelector('.text-muted');
                if (percentageText) {
                    percentageText.textContent = progress.progress_percentage + '%';
                }
            }
            
            // Show completion message if 100%
            if (progress.progress_percentage === 100) {
                const completionMessage = document.createElement('div');
                completionMessage.className = 'alert alert-success mt-3';
                completionMessage.innerHTML = '<i class="fas fa-trophy"></i> Congratulations! You have completed this lesson!';
                document.querySelector('.card-body').appendChild(completionMessage);
            }
            
        } else {
            alert('Error updating progress. Please try again.');
        }
    } catch (error) {
        console.error('Error marking content complete:', error);
        alert('Error updating progress. Please try again.');
    }
}

// Enhanced Navigation Functions
let currentPage = 0;
const totalPages = {{ lesson.pages|length if lesson.pages else 0 }};

// Initialize navigation on page load
document.addEventListener('DOMContentLoaded', function() {
    if (totalPages > 1) {
        initializeNavigation();
        setupKeyboardNavigation();
        showKeyboardHint();
    }
});

function initializeNavigation() {
    // Listen for carousel slide events
    const carousel = document.getElementById('lessonCarousel');
    if (carousel) {
        carousel.addEventListener('slide.bs.carousel', function(event) {
            currentPage = event.to;
            updateNavigationUI();
        });
    }
    
    // Update initial state
    updateNavigationUI();
}

function updateNavigationUI() {
    // Update page counters
    const pageText = `Page ${currentPage + 1} of ${totalPages}`;
    document.getElementById('pageCounter').textContent = pageText;
    document.getElementById('pageCounterBottom').textContent = pageText;
    
    // Update progress bar
    const progressPercentage = ((currentPage + 1) / totalPages) * 100;
    document.getElementById('navProgressFill').style.width = progressPercentage + '%';
    
    // Update button states
    const prevButtons = ['prevPageTop', 'prevPageBottom'];
    const nextButtons = ['nextPageTop', 'nextPageBottom'];
    
    prevButtons.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
            btn.disabled = currentPage === 0;
        }
    });
    
    nextButtons.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
            btn.disabled = currentPage === totalPages - 1;
        }
    });
    
    // Update page overview menu
    updatePageOverviewMenu();
}

function updatePageOverviewMenu() {
    const menuItems = document.querySelectorAll('.page-menu-item');
    menuItems.forEach((item, index) => {
        if (index === currentPage) {
            item.classList.add('active');
        } else {
            item.classList.remove('active');
        }
    });
}

function previousPage() {
    if (currentPage > 0) {
        const carousel = new bootstrap.Carousel(document.getElementById('lessonCarousel'));
        carousel.prev();
        // Scroll to top of the page
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function nextPage() {
    if (currentPage < totalPages - 1) {
        const carousel = new bootstrap.Carousel(document.getElementById('lessonCarousel'));
        carousel.next();
        // Scroll to top of the page
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function goToPage(pageIndex) {
    if (pageIndex >= 0 && pageIndex < totalPages) {
        const carousel = new bootstrap.Carousel(document.getElementById('lessonCarousel'));
        carousel.to(pageIndex);
        // Scroll to top of the page
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function togglePageOverview() {
    const content = document.getElementById('pageOverviewContent');
    const icon = document.getElementById('overviewToggleIcon');
    
    if (content.classList.contains('show')) {
        content.classList.remove('show');
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
    } else {
        content.classList.add('show');
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
    }
}

function setupKeyboardNavigation() {
    document.addEventListener('keydown', function(event) {
        // Only handle keyboard navigation if not typing in an input
        if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || event.target.tagName === 'SELECT') {
            return;
        }
        
        switch(event.key) {
            case 'ArrowLeft':
                event.preventDefault();
                previousPage();
                showKeyboardHint();
                break;
            case 'ArrowRight':
            case ' ':
                event.preventDefault();
                nextPage();
                showKeyboardHint();
                break;
            case 'Home':
                event.preventDefault();
                goToPage(0);
                showKeyboardHint();
                break;
            case 'End':
                event.preventDefault();
                goToPage(totalPages - 1);
                showKeyboardHint();
                break;
            case 'o':
            case 'O':
                event.preventDefault();
                togglePageOverview();
                break;
        }
    });
}

function showKeyboardHint() {
    // Create keyboard hint if it doesn't exist
    let hint = document.querySelector('.keyboard-hint');
    if (!hint) {
        hint = document.createElement('div');
        hint.className = 'keyboard-hint';
        hint.innerHTML = '← → Space: Navigate | O: Overview | Home/End: First/Last';
        document.body.appendChild(hint);
    }
    
    // Show hint briefly
    hint.classList.add('show');
    setTimeout(() => {
        hint.classList.remove('show');
    }, 3000);
}

// Touch/Swipe support for mobile
let touchStartX = 0;
let touchEndX = 0;

document.addEventListener('touchstart', function(event) {
    touchStartX = event.changedTouches[0].screenX;
});

document.addEventListener('touchend', function(event) {
    touchEndX = event.changedTouches[0].screenX;
    handleSwipe();
});

function handleSwipe() {
    const swipeThreshold = 50;
    const swipeDistance = touchEndX - touchStartX;
    
    if (Math.abs(swipeDistance) > swipeThreshold) {
        if (swipeDistance > 0) {
            // Swipe right - go to previous page
            previousPage();
        } else {
            // Swipe left - go to next page
            nextPage();
        }
    }
}

// Track time spent on page
window.addEventListener('beforeunload', function() {
    const timeSpent = Math.floor((Date.now() - startTime) / 60000);
    if (timeSpent > 0) {
        const lessonId = '{{ lesson.id }}';
        navigator.sendBeacon('/api/lessons/' + lessonId + '/progress', 
            JSON.stringify({ time_spent: timeSpent }));
    }
});
</script>
{% endblock %}

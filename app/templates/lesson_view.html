{% extends "base.html" %}

{% block title %}{{ lesson.title }} - Japanese Learning{% endblock %}

{% block content %}
<style>
    /* Enhanced Navigation Styles */
    .lesson-navigation-top {
        background: linear-gradient(135deg, #4a90e2 0%, #50e3c2 100%);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 12px rgba(74, 144, 226, 0.2);
    }
    
    .lesson-navigation-bottom {
        background-color: #ffffff;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 1rem 1.5rem;
        margin-top: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .page-counter {
        font-size: 1.1rem;
        font-weight: 600;
    }
    
    .nav-progress-bar {
        height: 8px;
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        overflow: hidden;
        margin: 0.5rem 0;
    }
    
    .nav-progress-fill {
        height: 100%;
        background-color: white;
        border-radius: 4px;
        transition: width 0.3s ease;
    }
    
    .nav-btn {
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        border-radius: 8px;
        transition: all 0.2s ease;
        border: none;
        min-width: 120px;
    }
    
    .nav-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .nav-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .nav-btn-primary {
        background-color: #4a90e2;
        color: white;
    }
    
    .nav-btn-secondary {
        background-color: #6c757d;
        color: white;
    }
    
    /* Page Overview Menu */
    .page-overview {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        margin-bottom: 1.5rem;
    }
    
    .page-overview-header {
        padding: 1rem 1.5rem;
        background-color: white;
        border-bottom: 1px solid #e9ecef;
        border-radius: 12px 12px 0 0;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    
    .page-overview-header:hover {
        background-color: #f8f9fa;
    }
    
    .page-overview-content {
        padding: 1rem;
        display: none;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .page-overview-content.show {
        display: block;
    }
    
    .page-menu-item {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        margin-bottom: 0.5rem;
        background-color: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        color: inherit;
    }
    
    .page-menu-item:hover {
        background-color: #4a90e2;
        color: white;
        transform: translateX(5px);
        text-decoration: none;
    }
    
    .page-menu-item.active {
        background-color: #50e3c2;
        color: white;
        border-color: #50e3c2;
    }
    
    .page-menu-number {
        background-color: #4a90e2;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin-right: 1rem;
        font-size: 0.9rem;
    }
    
    .page-menu-item.active .page-menu-number {
        background-color: white;
        color: #50e3c2;
    }
    
    .page-menu-item:hover .page-menu-number {
        background-color: white;
        color: #4a90e2;
    }
    
    /* Enhanced Carousel Controls */
    #lessonCarousel .carousel-control-prev,
    #lessonCarousel .carousel-control-next {
        width: 8%;
        top: 20%;
        height: 60%;
    }
    
    #lessonCarousel .carousel-control-prev-icon,
    #lessonCarousel .carousel-control-next-icon {
        background-color: rgba(74, 144, 226, 0.8);
        border-radius: 50%;
        padding: 25px;
        transition: all 0.3s ease;
    }
    
    #lessonCarousel .carousel-control-prev:hover .carousel-control-prev-icon,
    #lessonCarousel .carousel-control-next:hover .carousel-control-next-icon {
        background-color: #4a90e2;
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
    }
    
    #lessonCarousel .carousel-item .page-container {
        min-height: 400px;
    }
    
    /* Enhanced indicators */
    #lessonCarousel .carousel-indicators {
        position: static;
        margin-top: 1rem;
        margin-bottom: 1rem;
    }
    
    #lessonCarousel .carousel-indicators [data-bs-target] {
        background-color: #a0a0a0;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin: 0 5px;
        transition: all 0.3s ease;
    }
    
    #lessonCarousel .carousel-indicators .active {
        background-color: #4a90e2;
        transform: scale(1.2);
    }
    
    #lessonCarousel .carousel-indicators [data-bs-target]:hover {
        background-color: #50e3c2;
        transform: scale(1.1);
    }
    
    /* Keyboard navigation indicator */
    .keyboard-hint {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .keyboard-hint.show {
        opacity: 1;
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
        .lesson-navigation-top,
        .lesson-navigation-bottom {
            padding: 0.75rem 1rem;
        }
        
        .nav-btn {
            min-width: 100px;
            padding: 0.5rem 1rem;
        }
        
        .page-counter {
            font-size: 1rem;
        }
        
        #lessonCarousel .carousel-control-prev,
        #lessonCarousel .carousel-control-next {
            width: 12%;
        }
        
        .keyboard-hint {
            display: none;
        }
    }
</style>
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card lesson-header-card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h1 class="card-title">{{ lesson.title }}</h1>
                            <p class="card-text">{{ lesson.description or 'No description available.' }}</p>
                            
                            <div class="d-flex flex-wrap gap-2 mb-3">
                                {% if lesson.category %}
                                <span class="badge bg-info">{{ lesson.category.name }}</span>
                                {% endif %}
                                {% if lesson.difficulty_level %}
                                <span class="badge bg-secondary">Difficulty: {{ lesson.difficulty_level }}/5</span>
                                {% endif %}
                                {% if lesson.estimated_duration %}
                                <span class="badge bg-dark">{{ lesson.estimated_duration }} minutes</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            {% if lesson.thumbnail_url %}
                            <img src="{{ lesson.thumbnail_url }}" class="img-fluid rounded" alt="{{ lesson.title }}">
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if current_user.is_authenticated %}
                        {% if progress %}
                        <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">Your Progress</h6>
                                <span class="text-muted">{{ progress.progress_percentage }}%</span>
                            </div>
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: {{ progress.progress_percentage }}%" 
                                     aria-valuenow="{{ progress.progress_percentage }}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                            <div class="row text-center">
                                {% if progress.time_spent %}
                                <div class="col">
                                    <small class="text-muted">Time Spent: {{ progress.time_spent }} minutes</small>
                                </div>
                                {% endif %}
                                {% if progress.started_at %}
                                <div class="col">
                                    <small class="text-muted">Started: {{ progress.started_at.strftime('%Y-%m-%d') }}</small>
                                </div>
                                {% endif %}
                                {% if progress.completed_at %}
                                <div class="col">
                                    <small class="text-success">Completed: {{ progress.completed_at.strftime('%Y-%m-%d') }}</small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="mt-3">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> 
                                <strong>Guest Access:</strong> You're viewing this lesson as a guest. 
                                <a href="{{ url_for('routes.register') }}" class="alert-link">Create an account</a> 
                                or <a href="{{ url_for('routes.login') }}" class="alert-link">login</a> 
                                to track your progress and access quizzes.
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            {% if lesson.video_intro_url %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Introduction Video</h5>
                </div>
                <div class="card-body">
                    <div class="ratio ratio-16x9">
                        <iframe src="{{ lesson.video_intro_url | to_embed_url }}" allowfullscreen></iframe>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Enhanced Top Navigation -->
            {% if lesson.pages and lesson.pages|length > 1 %}
            <div class="lesson-navigation-top">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <button class="nav-btn nav-btn-secondary" id="prevPageTop" onclick="previousPage()" disabled>
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="page-counter" id="pageCounter">Page 1 of {{ lesson.pages|length }}</div>
                        <div class="nav-progress-bar">
                            <div class="nav-progress-fill" id="navProgressFill" style="width: {{ (100 / lesson.pages|length)|round(1) }}%"></div>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="nav-btn nav-btn-primary" id="nextPageTop" onclick="nextPage()">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Page Overview Menu -->
            <div class="page-overview">
                <div class="page-overview-header" onclick="togglePageOverview()">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-list"></i> Page Overview</h6>
                        <i class="fas fa-chevron-up" id="overviewToggleIcon"></i>
                    </div>
                </div>
                <div class="page-overview-content show" id="pageOverviewContent">
                    {% for page in lesson.pages %}
                    {% set page_content_count = page.content|length %}
                    {% if current_user.is_authenticated and progress %}
                        {% set content_progress = progress.get_content_progress() %}
                        {% set completed_content_ids = [] %}
                        {% for content in page.content %}
                            {% if content_progress.get(content.id|string) == true or content_progress.get(content.id) == true %}
                                {% if completed_content_ids.append(content.id) %}{% endif %}
                            {% endif %}
                        {% endfor %}
                        {% set completed_content_count = completed_content_ids|length %}
                    {% else %}
                        {% set completed_content_count = 0 %}
                    {% endif %}
                    <!-- DEBUG: Page {{ loop.index }}, Total: {{ page_content_count }}, Completed: {{ completed_content_count }} -->
                    <div class="page-menu-item" onclick="goToPage({{ loop.index0 }})" data-page="{{ loop.index0 }}">
                        <div class="page-menu-number">{{ loop.index }}</div>
                        <div class="flex-grow-1">
                            <div class="fw-bold">{{ page.metadata.title or (page.content[0].title if page.content else 'Page ' ~ loop.index) }}</div>
                            {% if page.metadata.description %}
                            <small class="text-muted">{{ page.metadata.description }}</small>
                            {% endif %}
                            {% if current_user.is_authenticated %}
                            <div class="mt-1">
                                <small class="text-muted">
                                    <i class="fas fa-check-circle"></i> 
                                    {{ completed_content_count }}/{{ page_content_count }} completed
                                </small>
                                {% if page_content_count > 0 %}
                                <div class="progress mt-1" style="height: 6px; background-color: #e9ecef; border-radius: 3px;">
                                    <div class="progress-bar bg-success" role="progressbar" 
                                         style="width: {{ (completed_content_count / page_content_count * 100)|round(1) }}%; min-width: 0;" 
                                         aria-valuenow="{{ (completed_content_count / page_content_count * 100)|round(1) }}" 
                                         aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            {% else %}
                            <div class="mt-1">
                                <small class="text-muted">
                                    <i class="fas fa-list"></i> 
                                    {{ page_content_count }} content item{{ 's' if page_content_count != 1 else '' }}
                                </small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="card lesson-content-card">
                <div class="card-header">
                    <h5 class="mb-0">Lesson Content</h5>
                </div>
                <div class="card-body">
                    {% if lesson.pages %}
                        <div id="lessonCarousel" class="carousel slide" data-bs-interval="false">
                            <div class="carousel-inner">
                                {% for page in lesson.pages %}
                                <div class="carousel-item {% if loop.first %}active{% endif %}">
                                    <div class="page-container p-3">
                                        <h4 class="page-title mb-2 text-center">
                                            {{ page.metadata.title or 'Page ' ~ loop.index }}
                                        </h4>
                                        {% if page.metadata.description %}
                                        <p class="page-description text-center text-muted mb-4">{{ page.metadata.description }}</p>
                                        {% endif %}
                                        
                                        {% for content in page.content %}
                                        <div class="content-item mb-4 p-3 border rounded bg-white shadow-sm" data-content-id="{{ content.id }}">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h6 class="mb-0">
                                                    {{ content.title or (content.content_type + ' #' + (content.content_id | string if content.content_id else 'Custom')) }}
                                                    {% if content.is_optional %}
                                                    <span class="badge bg-warning ms-2">Optional</span>
                                                    {% endif %}
                                                </h6>
                                                {% if current_user.is_authenticated %}
                                                {% if not content.is_interactive %}
                                                <button class="btn btn-sm btn-outline-success mark-complete-btn" 
                                                        onclick="markContentComplete({{ content.id }})"
                                                        {% if progress and progress.get_content_progress().get(content.id | string) %}
                                                        style="display: none;"
                                                        {% endif %}>
                                                    Mark Complete
                                                </button>
                                                {% endif %}
                                                <span class="badge bg-success completed-badge" 
                                                      {% if not (progress and progress.get_content_progress().get(content.id | string)) %}
                                                      style="display: none;"
                                                      {% endif %}>
                                                    ✓ Completed
                                                </span>
                                                {% endif %}
                                            </div>
                                            
                                            <div class="content-body">
                                                {% if content.content_type in ['kana', 'kanji', 'vocabulary', 'grammar'] %}
                                                    {% set content_data = content.get_content_data() %}
                                                    {% if content_data %}
                                                        <div class="flip-card">
                                                            <button class="card-scene" 
                                                                    aria-label="Flip card for {% if content.content_type in ['kana', 'kanji'] %}{{ content_data.character }}{% elif content.content_type == 'vocabulary' %}{{ content_data.word }}{% else %}{{ content_data.title }}{% endif %} to see details"
                                                                    tabindex="0">
                                                                <div class="card-flipper">
                                                                    <div class="card-face card-face--front">
                                                                        {% if content.content_type == 'kana' %}
                                                                            <span class="kana-char">{{ content_data.character }}</span>
                                                                        {% elif content.content_type == 'kanji' %}
                                                                            <span class="kana-char">{{ content_data.character }}</span>
                                                                        {% elif content.content_type == 'vocabulary' %}
                                                                            <div class="vocab-front">
                                                                                <div class="vocab-word">{{ content_data.word }}</div>
                                                                                <div class="vocab-reading">{{ content_data.reading }}</div>
                                                                            </div>
                                                                        {% elif content.content_type == 'grammar' %}
                                                                            <div class="grammar-front">
                                                                                <div class="grammar-title">{{ content_data.title }}</div>
                                                                                {% if content_data.structure %}
                                                                                <div class="grammar-structure">{{ content_data.structure }}</div>
                                                                                {% endif %}
                                                                            </div>
                                                                        {% endif %}
                                                                        <div class="flip-hint">Click to flip</div>
                                                                    </div>
                                                                    
                                                                    <div class="card-face card-face--back">
                                                                        <div class="details">
                                                                            {% if content.content_type == 'kana' %}
                                                                                <p><strong>Romanization:</strong> {{ content_data.romanization }}</p>
                                                                                <p><strong>Type:</strong> {{ content_data.type | title }}</p>
                                                                                {% if content_data.stroke_order_info %}
                                                                                <p><strong>Stroke Order:</strong> {{ content_data.stroke_order_info }}</p>
                                                                                {% endif %}
                                                                            {% elif content.content_type == 'kanji' %}
                                                                                <p><strong>Meaning:</strong> {{ content_data.meaning }}</p>
                                                                                {% if content_data.onyomi %}
                                                                                <p><strong>On'yomi:</strong> {{ content_data.onyomi }}</p>
                                                                                {% endif %}
                                                                                {% if content_data.kunyomi %}
                                                                                <p><strong>Kun'yomi:</strong> {{ content_data.kunyomi }}</p>
                                                                                {% endif %}
                                                                                {% if content_data.jlpt_level %}
                                                                                <p><strong>JLPT Level:</strong> N{{ content_data.jlpt_level }}</p>
                                                                                {% endif %}
                                                                            {% elif content.content_type == 'vocabulary' %}
                                                                                <p><strong>Meaning:</strong> {{ content_data.meaning }}</p>
                                                                                {% if content_data.example_sentence_japanese %}
                                                                                <p><strong>Example:</strong><br>{{ content_data.example_sentence_japanese }}</p>
                                                                                {% if content_data.example_sentence_english %}
                                                                                <p><strong>Translation:</strong><br>{{ content_data.example_sentence_english }}</p>
                                                                                {% endif %}
                                                                                {% endif %}
                                                                            {% elif content.content_type == 'grammar' %}
                                                                                <p><strong>Explanation:</strong><br>{{ content_data.explanation }}</p>
                                                                                {% if content_data.example_sentences %}
                                                                                <p><strong>Examples:</strong><br>{{ content_data.example_sentences }}</p>
                                                                                {% endif %}
                                                                            {% endif %}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </button>
                                                        </div>
                                                    {% else %}
                                                        <p class="text-muted">Content not found.</p>
                                                    {% endif %}
                                                {% else %}
                                                    {% if content.content_type == 'text' %}
                                                    <div class="text-content-container">
                                                        <div class="rich-text-content">
                                                            {{ content.content_text | safe }}
                                                        </div>
                                                    </div>
                                                    {% else %}
                                                        {% if content.content_type == 'image' %}
                                                            {% if content.file_path %}
                                                            <img src="{{ url_for('static', filename='uploads/' + content.file_path) }}" class="img-fluid rounded" alt="{{ content.title }}" style="max-width: 100%; height: auto;">
                                                            {% elif content.media_url %}
                                                            <img src="{{ content.media_url }}" class="img-fluid rounded" alt="{{ content.title }}" style="max-width: 100%; height: auto;">
                                                            {% endif %}
                                                        {% elif content.media_url %}
                                                            {% if content.content_type == 'video' %}
                                                            <div class="ratio ratio-16x9">
                                                                <iframe src="{{ content.media_url | to_embed_url }}" allowfullscreen></iframe>
                                                            </div>
                                                            {% elif content.content_type == 'audio' %}
                                                            <audio controls class="w-100">
                                                                <source src="{{ content.media_url }}" type="audio/mpeg">
                                                                Your browser does not support the audio element.
                                                            </audio>
                                                            {% endif %}
                                                        {% else %}
                                                            {% if content.content_text %}
                                                            <div class="mb-3">{{ content.content_text | safe }}</div>
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endif %}
                                                {% endif %}
                                                {% if content.is_interactive %}
                                                {% if current_user.is_authenticated %}
                                                <div class="interactive-content-container" data-content-id="{{ content.id }}">
                                                    {% for question in content.quiz_questions %}
                                                    {% set user_answer = user_quiz_answers.get(question.id) %}
                                                    <div class="quiz-question mb-4" data-question-id="{{ question.id }}" data-question-type="{{ question.question_type }}">
                                                        <div class="question-header mb-3">
                                                            <h5>{{ question.question_text | safe }}</h5>
                                                            {% if question.points > 1 %}
                                                            <span class="badge bg-primary">{{ question.points }} points</span>
                                                            {% endif %}
                                                            {% if user_answer and user_answer.is_correct %}
                                                            <span class="badge bg-success ms-2">✓ Completed</span>
                                                            {% endif %}
                                                        </div>
                                                        
                                                        {% if question.question_type == 'multiple_choice' %}
                                                        <div class="multiple-choice-options">
                                                            {% for option in question.options | sort(attribute='order_index') %}
                                                            <div class="form-check mb-2">
                                                                <input class="form-check-input" type="radio" name="question_{{ question.id }}" 
                                                                       id="option_{{ option.id }}" value="{{ option.id }}"
                                                                       {% if user_answer and user_answer.selected_option_id == option.id %}checked{% endif %}
                                                                       {% if user_answer and user_answer.is_correct %}disabled{% endif %}>
                                                                <label class="form-check-label" for="option_{{ option.id }}">
                                                                    {{ option.option_text }}
                                                                </label>
                                                            </div>
                                                            {% endfor %}
                                                        </div>
                                                        
                                                        {% elif question.question_type == 'fill_blank' %}
                                                        <div class="fill-blank-input">
                                                            <div class="question-text mb-3">
                                                                {% if user_answer and user_answer.text_answer %}
                                                                {% set input_html = '<input type="text" class="form-control d-inline-block" style="width: 200px;" id="blank_' ~ question.id ~ '" value="' ~ user_answer.text_answer ~ '"' ~ (' disabled' if user_answer.is_correct else '') ~ '>' %}
                                                                {{ question.question_text | replace('___', input_html) | safe }}
                                                                {% else %}
                                                                {% set input_html = '<input type="text" class="form-control d-inline-block" style="width: 200px;" id="blank_' ~ question.id ~ '">' %}
                                                                {{ question.question_text | replace('___', input_html) | safe }}
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        
                                                        {% elif question.question_type == 'true_false' %}
                                                        <div class="true-false-options">
                                                            {% for option in question.options | sort(attribute='order_index') %}
                                                            <div class="form-check mb-2">
                                                                <input class="form-check-input" type="radio" name="question_{{ question.id }}" 
                                                                       id="option_{{ option.id }}" value="{{ option.id }}"
                                                                       {% if user_answer and user_answer.selected_option_id == option.id %}checked{% endif %}
                                                                       {% if user_answer and user_answer.is_correct %}disabled{% endif %}>
                                                                <label class="form-check-label" for="option_{{ option.id }}">
                                                                    {{ option.option_text }}
                                                                </label>
                                                            </div>
                                                            {% endfor %}
                                                        </div>
                                                        
                                        {% elif question.question_type == 'matching' %}
                                        <div class="matching-quiz">
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <div class="matching-instructions mb-3">
                                                        <p class="text-muted">Match each Japanese term with its correct English meaning:</p>
                                                    </div>
                                                    <div class="matching-pairs">
                                                        {% for option in question.options | sort(attribute='order_index') %}
                                                        <div class="matching-pair mb-3 p-3 border rounded">
                                                            <div class="row align-items-center">
                                                                <div class="col-md-6">
                                                                    <div class="matching-prompt">
                                                                        <strong>{{ option.option_text }}</strong>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    {% set display_answer = '' %}
                                                                    {% if user_answer and user_answer.is_correct %}
                                                                        {# If quiz is completed correctly, show the correct answer #}
                                                                        {% set display_answer = option.feedback %}
                                                                    {% elif user_answer and user_answer.text_answer %}
                                                                        {# If quiz is not completed, show user's last selection #}
                                                                        {% set user_pairs = user_answer.text_answer | from_json %}
                                                                        {% for pair in user_pairs %}
                                                                            {% if pair.prompt == option.option_text %}
                                                                                {% set display_answer = pair.answer %}
                                                                            {% endif %}
                                                                        {% endfor %}
                                                                    {% endif %}
                                                                    <select class="form-select matching-select" 
                                                                            data-prompt="{{ option.option_text }}" 
                                                                            data-correct-answer="{{ option.feedback }}"
                                                                            data-question-id="{{ question.id }}"
                                                                            {% if user_answer and user_answer.is_correct %}disabled{% endif %}>
                                                                        <option value="">Choose...</option>
                                                                        {% for answer_option in question.options | sort(attribute='order_index') %}
                                                                        <option value="{{ answer_option.feedback }}" {% if display_answer == answer_option.feedback %}selected{% endif %}>{{ answer_option.feedback }}</option>
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                                        {% endif %}
                                                        
                                                        <div class="question-actions mt-3">
                                                            <button class="btn btn-primary" onclick="submitQuizAnswer('{{ lesson.id }}', '{{ question.id }}')">
                                                                Submit Answer
                                                            </button>
                                                            <div class="quiz-feedback mt-2" id="feedback_{{ question.id }}" 
                                                                 {% if user_answer %}style="display: block;"{% else %}style="display: none;"{% endif %}>
                                                                {% if user_answer %}
                                                                    {% if user_answer.is_correct %}
                                                                    <div class="alert alert-success">✓ Correct!</div>
                                                                    {% else %}
                                                                    <div class="alert alert-danger">✗ Incorrect</div>
                                                                    {% endif %}
                                                                    {% if question.explanation %}
                                                                    <div class="alert alert-info">{{ question.explanation }}</div>
                                                                    {% endif %}
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="quiz-attempts mt-2">
                                                            <small class="text-muted">
                                                                Attempts remaining: <span id="attempts_{{ question.id }}">
                                                                    {% if user_answer %}
                                                                        {% if content.max_attempts %}
                                                                            {{ content.max_attempts - user_answer.attempts }}
                                                                        {% else %}
                                                                            Unlimited
                                                                        {% endif %}
                                                                    {% else %}
                                                                        {{ content.max_attempts or 'Unlimited' }}
                                                                    {% endif %}
                                                                </span>
                                                            </small>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                {% else %}
                                                <div class="alert alert-warning">
                                                    <i class="fas fa-lock"></i> 
                                                    <strong>Quiz Available:</strong> This lesson contains interactive quizzes. 
                                                    <a href="{{ url_for('routes.login') }}" class="alert-link">Login</a> 
                                                    to access the quiz features.
                                                </div>
                                                {% endif %}
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <h5 class="text-muted">No content available yet</h5>
                            <p class="text-muted">This lesson is still being prepared. Please check back later.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Enhanced Bottom Navigation -->
            {% if lesson.pages and lesson.pages|length > 1 %}
            <div class="lesson-navigation-bottom">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <button class="nav-btn nav-btn-secondary" id="prevPageBottom" onclick="previousPage()" disabled>
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="page-counter" id="pageCounterBottom">Page 1 of {{ lesson.pages|length }}</div>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="nav-btn nav-btn-primary" id="nextPageBottom" onclick="nextPage()">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="mt-4 d-flex justify-content-between">
                <a href="{{ url_for('routes.lessons') }}" class="btn btn-outline-secondary">
                    ← Back to Lessons
                </a>
                
                <div>
                    {% if progress and progress.progress_percentage == 100 %}
                    <span class="text-success me-3">
                        <i class="fas fa-check-circle"></i> Lesson Completed!
                    </span>
                    {% endif %}

                    {% if progress and (progress.progress_percentage > 0 or progress.is_completed) %}
                    <form action="{{ url_for('routes.reset_lesson_progress', lesson_id=lesson.id) }}" method="POST" class="d-inline">
                        {{ form.hidden_tag() }}
                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to reset your progress for this lesson?');">
                            <i class="fas fa-undo"></i> Reset Progress
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Server-side data rendered by Jinja2
const lessonData = {
    id: '{{ lesson.id }}',
    totalPages: {{ lesson.pages|length if lesson.pages else 0 }},
    {% if current_user.is_authenticated and progress %}
    contentProgress: {{ progress.get_content_progress() | tojson }},
    hasProgress: true
    {% else %}
    contentProgress: {},
    hasProgress: false
    {% endif %}
};

let startTime = Date.now();

// 3D Flip Card JavaScript - Scalable Implementation
document.addEventListener('DOMContentLoaded', () => {
    // Select all card components on the page
    const cards = document.querySelectorAll('.card-scene');

    cards.forEach(card => {
        // Set the initial accessibility state for screen readers
        card.setAttribute('aria-pressed', 'false');

        // Find the flipper element within this specific card
        const flipper = card.querySelector('.card-flipper');

        // Add click event listener to the card (the button)
        card.addEventListener('click', () => {
            // Check if the card is currently flipped
            const isFlipped = flipper.classList.contains('is-flipped');

            // Toggle the flip state
            flipper.classList.toggle('is-flipped');

            // Update the ARIA attribute to match the new state
            card.setAttribute('aria-pressed', !isFlipped);
        });

        // Add keyboard support (Enter and Space keys)
        card.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault(); // Prevent page scroll on Space
                card.click(); // Trigger the click event
            }
        });
    });

    // Shuffle matching quiz options while preserving selected state
    const matchingSelects = document.querySelectorAll('.matching-select');
    matchingSelects.forEach(select => {
        // Store the currently selected value from the server-side template
        let selectedValue = '';
        
        // First try to get the selected value from the select element itself
        if (select.value && select.value !== '') {
            selectedValue = select.value;
            console.log('Found selected value from select.value:', selectedValue);
        } else {
            // Try to find an option with the 'selected' attribute
            const selectedOption = select.querySelector('option[selected]');
            if (selectedOption) {
                selectedValue = selectedOption.value;
                console.log('Found selected value from selected attribute:', selectedValue);
            }
        }
        
        // Only shuffle if there are options to shuffle (more than just "Choose...")
        const options = Array.from(select.querySelectorAll('option')).slice(1);
        if (options.length <= 1) {
            console.log('Not enough options to shuffle for this select');
            return; // Skip shuffling if there's only one or no options
        }
        
        console.log('Shuffling matching quiz options, preserving selection:', selectedValue);
        
        // Create new option elements to avoid DOM manipulation issues
        const newOptions = options.map(option => {
            const newOption = document.createElement('option');
            newOption.value = option.value;
            newOption.textContent = option.textContent;
            return newOption;
        });
        
        // Shuffle the new options
        const shuffled = shuffleArray(newOptions);
        
        // Remove all options except the first "Choose..." one
        while (select.children.length > 1) {
            select.removeChild(select.lastChild);
        }
        
        // Add shuffled options back
        shuffled.forEach(option => {
            select.appendChild(option);
        });
        
        // Restore the selected value
        if (selectedValue && selectedValue !== '') {
            // Use a timeout to ensure DOM is fully updated
            setTimeout(() => {
                select.value = selectedValue;
                console.log('Restored matching quiz selection:', selectedValue, 'Current value:', select.value);
                
                // Verify the selection was applied correctly
                if (select.value === selectedValue) {
                    console.log('✓ Matching quiz selection successfully restored');
                } else {
                    console.warn('✗ Failed to restore matching quiz selection');
                }
            }, 10);
        }
    });
});

// Helper function to shuffle array
function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

async function submitQuizAnswer(lessonId, questionId) {
    const questionElement = document.querySelector(`[data-question-id="${questionId}"]`);
    const questionType = questionElement.dataset.questionType;
    
    let answerData = {};
    
    if (questionType === 'multiple_choice' || questionType === 'true_false') {
        const selectedOption = questionElement.querySelector(`input[name="question_${questionId}"]:checked`);
        if (!selectedOption) {
            alert('Please select an answer');
            return;
        }
        answerData.selected_option_id = selectedOption.value;
        console.log('Selected option ID:', answerData.selected_option_id);
    } else if (questionType === 'fill_blank') {
        const textInput = questionElement.querySelector(`#blank_${questionId}`);
        if (!textInput || !textInput.value.trim()) {
            alert('Please provide an answer');
            return;
        }
        answerData.text_answer = textInput.value.trim();
    } else if (questionType === 'matching') {
        const selects = questionElement.querySelectorAll('.matching-select');
        let allSelected = true;
        answerData.pairs = [];
        
        selects.forEach(select => {
            if (!select.value || select.value === '') {
                allSelected = false;
            } else {
                answerData.pairs.push({
                    prompt: select.dataset.prompt,
                    answer: select.value,
                    correct_answer: select.dataset.correctAnswer
                });
            }
        });

        if (!allSelected) {
            alert('Please match all items.');
            return;
        }
    }
    
    try {
        const csrfTokenElement = document.querySelector('meta[name="csrf-token"]');
        const csrfToken = csrfTokenElement ? csrfTokenElement.getAttribute('content') : null;
        
        const headers = { 
            'Content-Type': 'application/json'
        };
        
        // Only add CSRF token if it exists
        if (csrfToken) {
            headers['X-CSRFToken'] = csrfToken;
        }
        
        const response = await fetch('/api/lessons/' + lessonId + '/quiz/' + questionId + '/answer', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(answerData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showQuizFeedback(questionId, result);
            updateAttempts(questionId, result.attempts_remaining);
            
            if (result.is_correct) {
                markContentComplete(questionElement.closest('[data-content-id]').dataset.contentId);
            }
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        console.error('Error submitting answer:', error);
        alert('Error submitting answer');
    }
}

function showQuizFeedback(questionId, result) {
    const feedbackElement = document.getElementById(`feedback_${questionId}`);
    
    let feedbackHtml = '';
    if (result.is_correct) {
        feedbackHtml = '<div class="alert alert-success">✓ Correct!</div>';
    } else {
        feedbackHtml = '<div class="alert alert-danger">✗ Incorrect</div>';
    }
    
    if (result.explanation) {
        feedbackHtml += `<div class="alert alert-info">${result.explanation}</div>`;
    }
    
    if (result.option_feedback) {
        feedbackHtml += `<div class="alert alert-warning">${result.option_feedback}</div>`;
    }
    
    feedbackElement.innerHTML = feedbackHtml;
    feedbackElement.style.display = 'block';
    
    // Disable question if correct or no attempts remaining
    if (result.is_correct || result.attempts_remaining === 0) {
        const questionElement = document.querySelector(`[data-question-id="${questionId}"]`);
        const inputs = questionElement.querySelectorAll('input');
        const button = questionElement.querySelector('button');
        
        inputs.forEach(input => input.disabled = true);
        if(button) button.disabled = true;
    }
}

function updateAttempts(questionId, attemptsRemaining) {
    const attemptsElement = document.getElementById(`attempts_${questionId}`);
    if (attemptsElement) {
        attemptsElement.textContent = attemptsRemaining;
    }
}

async function markContentComplete(contentId) {
    try {
        const lessonId = lessonData.id;
        
        // Get CSRF token from meta tag
        const csrfTokenElement = document.querySelector('meta[name="csrf-token"]');
        if (!csrfTokenElement) {
            console.error('CSRF token not found in meta tag');
            alert('Security token missing. Please refresh the page.');
            return;
        }
        
        const csrfToken = csrfTokenElement.getAttribute('content');
        console.log('CSRF token found:', csrfToken ? 'Yes' : 'No');
        
        const headers = { 
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        };
        
        const requestData = { 
            content_id: contentId,
            time_spent: Math.floor((Date.now() - startTime) / 60000) // minutes
        };
        
        console.log('Sending request to mark content complete:', requestData);
        console.log('Headers:', headers);
        
        const response = await fetch('/api/lessons/' + lessonId + '/progress', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(requestData)
        });
        
        console.log('Response status:', response.status);
        
        if (response.ok) {
            const progress = await response.json();
            console.log('Progress updated successfully:', progress);
            
            // Update UI
            const contentItem = document.querySelector(`[data-content-id="${contentId}"]`);
            if (contentItem) {
                const markBtn = contentItem.querySelector('.mark-complete-btn');
                const completedBadge = contentItem.querySelector('.completed-badge');
                
                if (markBtn) markBtn.style.display = 'none';
                if (completedBadge) completedBadge.style.display = 'inline';
            }
            
            // Update progress bar
            const progressBar = document.querySelector('.progress-bar');
            if (progressBar) {
                progressBar.style.width = progress.progress_percentage + '%';
                progressBar.setAttribute('aria-valuenow', progress.progress_percentage);
                
                // Update percentage text
                const percentageText = document.querySelector('.progress').previousElementSibling?.querySelector('.text-muted');
                if (percentageText) {
                    percentageText.textContent = progress.progress_percentage + '%';
                }
            }
            
            // Update page overview completion counts
            try {
                updatePageOverviewCompletionCounts(contentId);
            } catch (overviewError) {
                console.warn('Error updating page overview:', overviewError);
                // Don't show error to user for this non-critical update
            }
            
            // Show completion message if 100%
            if (progress.progress_percentage === 100) {
                const cardBody = document.querySelector('.card-body');
                if (cardBody && !cardBody.querySelector('.alert-success')) {
                    const completionMessage = document.createElement('div');
                    completionMessage.className = 'alert alert-success mt-3';
                    completionMessage.innerHTML = '<i class="fas fa-trophy"></i> Congratulations! You have completed this lesson!';
                    cardBody.appendChild(completionMessage);
                }
            }
            
        } else {
            const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
            console.error('Server error response:', errorData);
            alert('Error updating progress: ' + (errorData.error || 'Please try again.'));
        }
    } catch (error) {
        console.error('Error marking content complete:', error);
        // Only show error if it's a network error or parsing error
        if (error instanceof TypeError && error.message.includes('fetch')) {
            alert('Network error. Please check your connection and try again.');
        } else if (error instanceof SyntaxError) {
            alert('Server response error. Please try again.');
        } else {
            console.error('Unexpected error in markContentComplete:', error);
            // Don't show alert for unexpected errors that might be UI-related
        }
    }
}

// Enhanced Navigation Functions
let currentPage = 0;
const totalPages = lessonData.totalPages;

// Initialize navigation on page load
document.addEventListener('DOMContentLoaded', function() {
    if (totalPages > 1) {
        initializeNavigation();
        setupKeyboardNavigation();
        showKeyboardHint();
        
        // Restore page from URL hash
        restorePageFromURL();
    }
    
    // Initialize page overview completion counts on page load
    // This ensures the server-side calculated values are preserved
    initializePageOverviewCompletionCounts();
});

function initializeNavigation() {
    // Listen for carousel slide events
    const carousel = document.getElementById('lessonCarousel');
    if (carousel) {
        carousel.addEventListener('slide.bs.carousel', function(event) {
            currentPage = event.to;
            updateNavigationUI();
            updateURLHash();
        });
    }
    
    // Update initial state
    updateNavigationUI();
}

function restorePageFromURL() {
    // Check if there's a page hash in the URL
    const hash = window.location.hash;
    if (hash && hash.startsWith('#page-')) {
        const pageNum = parseInt(hash.replace('#page-', ''), 10);
        if (pageNum >= 1 && pageNum <= totalPages) {
            const pageIndex = pageNum - 1;
            goToPage(pageIndex);
            return;
        }
    }
    
    // No valid hash found, stay on page 1
    currentPage = 0;
    updateNavigationUI();
}

function updateURLHash() {
    // Update URL hash without triggering page reload
    const newHash = `#page-${currentPage + 1}`;
    if (window.location.hash !== newHash) {
        history.replaceState(null, null, newHash);
    }
}

function updateNavigationUI() {
    // Update page counters
    const pageText = `Page ${currentPage + 1} of ${totalPages}`;
    document.getElementById('pageCounter').textContent = pageText;
    document.getElementById('pageCounterBottom').textContent = pageText;
    
    // Update progress bar
    const progressPercentage = ((currentPage + 1) / totalPages) * 100;
    document.getElementById('navProgressFill').style.width = progressPercentage + '%';
    
    // Update button states
    const prevButtons = ['prevPageTop', 'prevPageBottom'];
    const nextButtons = ['nextPageTop', 'nextPageBottom'];
    
    prevButtons.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
            btn.disabled = currentPage === 0;
        }
    });
    
    nextButtons.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
            btn.disabled = currentPage === totalPages - 1;
        }
    });
    
    // Update page overview menu
    updatePageOverviewMenu();
}

function updatePageOverviewMenu() {
    const menuItems = document.querySelectorAll('.page-menu-item');
    menuItems.forEach((item, index) => {
        if (index === currentPage) {
            item.classList.add('active');
        } else {
            item.classList.remove('active');
        }
    });
}

function previousPage() {
    if (currentPage > 0) {
        const carousel = new bootstrap.Carousel(document.getElementById('lessonCarousel'));
        carousel.prev();
        // Scroll to top of the page
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function nextPage() {
    if (currentPage < totalPages - 1) {
        const carousel = new bootstrap.Carousel(document.getElementById('lessonCarousel'));
        carousel.next();
        // Scroll to top of the page
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function goToPage(pageIndex) {
    if (pageIndex >= 0 && pageIndex < totalPages) {
        const carousel = new bootstrap.Carousel(document.getElementById('lessonCarousel'));
        carousel.to(pageIndex);
        // Scroll to top of the page
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function togglePageOverview() {
    const content = document.getElementById('pageOverviewContent');
    const icon = document.getElementById('overviewToggleIcon');
    
    if (content.classList.contains('show')) {
        content.classList.remove('show');
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
    } else {
        content.classList.add('show');
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
    }
}

function setupKeyboardNavigation() {
    document.addEventListener('keydown', function(event) {
        // Only handle keyboard navigation if not typing in an input
        if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || event.target.tagName === 'SELECT') {
            return;
        }
        
        switch(event.key) {
            case 'ArrowLeft':
                event.preventDefault();
                previousPage();
                showKeyboardHint();
                break;
            case 'ArrowRight':
            case ' ':
                event.preventDefault();
                nextPage();
                showKeyboardHint();
                break;
            case 'Home':
                event.preventDefault();
                goToPage(0);
                showKeyboardHint();
                break;
            case 'End':
                event.preventDefault();
                goToPage(totalPages - 1);
                showKeyboardHint();
                break;
            case 'o':
            case 'O':
                event.preventDefault();
                togglePageOverview();
                break;
        }
    });
}

function showKeyboardHint() {
    // Create keyboard hint if it doesn't exist
    let hint = document.querySelector('.keyboard-hint');
    if (!hint) {
        hint = document.createElement('div');
        hint.className = 'keyboard-hint';
        hint.innerHTML = '← → Space: Navigate | O: Overview | Home/End: First/Last';
        document.body.appendChild(hint);
    }
    
    // Show hint briefly
    hint.classList.add('show');
    setTimeout(() => {
        hint.classList.remove('show');
    }, 3000);
}

// Touch/Swipe support for mobile
let touchStartX = 0;
let touchEndX = 0;

document.addEventListener('touchstart', function(event) {
    touchStartX = event.changedTouches[0].screenX;
});

document.addEventListener('touchend', function(event) {
    touchEndX = event.changedTouches[0].screenX;
    handleSwipe();
});

function handleSwipe() {
    const swipeThreshold = 50;
    const swipeDistance = touchEndX - touchStartX;
    
    if (Math.abs(swipeDistance) > swipeThreshold) {
        if (swipeDistance > 0) {
            // Swipe right - go to previous page
            previousPage();
        } else {
            // Swipe left - go to next page
            nextPage();
        }
    }
}

function initializePageOverviewCompletionCounts() {
    // This function preserves the server-side calculated completion counts
    // and ensures the DOM state matches the server-side progress data
    console.log('Initializing page overview completion counts...');
    
    // Set the correct DOM state for all content items based on server-side progress data
    if (lessonData.hasProgress && lessonData.contentProgress) {
        try {
            const contentProgress = lessonData.contentProgress;
            console.log('Server-side content progress:', contentProgress);
            
            // Update DOM elements to match server-side progress
            Object.keys(contentProgress).forEach(contentId => {
                if (contentProgress[contentId] === true) {
                    const contentItem = document.querySelector(`[data-content-id="${contentId}"]`);
                    if (contentItem) {
                        const markBtn = contentItem.querySelector('.mark-complete-btn');
                        const completedBadge = contentItem.querySelector('.completed-badge');
                        
                        if (markBtn) markBtn.style.display = 'none';
                        if (completedBadge) completedBadge.style.display = 'inline';
                    }
                }
            });
        } catch (error) {
            console.error('Error initializing content progress:', error);
        }
    }
    
    // The server-side template has already calculated the correct completion counts
    // We don't need to recalculate them on initial load, just ensure they're preserved
    const pageOverviewContent = document.getElementById('pageOverviewContent');
    if (pageOverviewContent && pageOverviewContent.classList.contains('show')) {
        console.log('Page overview is visible with server-side calculated counts preserved');
    }
}

function updatePageOverviewCompletionCounts(completedContentId) {
    console.log('Updating page overview completion counts for content ID:', completedContentId);
    
    // Get all page menu items
    const pageMenuItems = document.querySelectorAll('.page-menu-item');
    
    pageMenuItems.forEach((menuItem, pageIndex) => {
        // Get the page number from the data attribute or calculate it
        const pageNumber = pageIndex + 1;
        
        // Get all content items for this specific page
        const pageContentItems = document.querySelectorAll(`.carousel-item:nth-child(${pageNumber}) [data-content-id]`);
        
        let completedCount = 0;
        const totalCount = pageContentItems.length;
        
        // Count completed items by checking both the completed badge visibility and mark complete button visibility
        pageContentItems.forEach(contentItem => {
            const contentId = contentItem.getAttribute('data-content-id');
            const completedBadge = contentItem.querySelector('.completed-badge');
            const markCompleteBtn = contentItem.querySelector('.mark-complete-btn');
            
            // An item is completed if:
            // 1. The completed badge is visible (not hidden)
            // 2. OR the mark complete button is hidden (meaning it was completed)
            // 3. OR this is the content item that was just completed
            const isCompleted = (completedBadge && completedBadge.style.display !== 'none') ||
                              (markCompleteBtn && markCompleteBtn.style.display === 'none') ||
                              (completedContentId && contentId === completedContentId.toString());
            
            if (isCompleted) {
                completedCount++;
            }
        });
        
        console.log(`Page ${pageNumber}: ${completedCount}/${totalCount} completed`);
        
        // Update the completion text
        const completionText = menuItem.querySelector('small');
        if (completionText) {
            completionText.innerHTML = `<i class="fas fa-check-circle"></i> ${completedCount}/${totalCount} completed`;
        }
        
        // Update the progress bar
        const progressBar = menuItem.querySelector('.progress-bar');
        if (progressBar && totalCount > 0) {
            const percentage = Math.round((completedCount / totalCount) * 100);
            progressBar.style.width = percentage + '%';
            progressBar.setAttribute('aria-valuenow', percentage);
        }
    });
}

// Track time spent on page
window.addEventListener('beforeunload', function() {
    const timeSpent = Math.floor((Date.now() - startTime) / 60000);
    if (timeSpent > 0) {
        const lessonId = lessonData.id;
        
        // Get CSRF token for sendBeacon
        const csrfTokenElement = document.querySelector('meta[name="csrf-token"]');
        if (csrfTokenElement) {
            const csrfToken = csrfTokenElement.getAttribute('content');
            
            // Create form data with CSRF token for sendBeacon
            const formData = new FormData();
            formData.append('time_spent', timeSpent);
            formData.append('csrf_token', csrfToken);
            
            navigator.sendBeacon('/api/lessons/' + lessonId + '/progress', formData);
        }
    }
});

// Japanese Text Auto-Detection and Audio System
class JapaneseTextAudioSystem {
    constructor() {
        this.japaneseRegex = /[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF\u3000-\u303F]/;
        this.init();
    }
    
    init() {
        // Process content when page loads
        document.addEventListener('DOMContentLoaded', () => {
            this.processAllContent();
        });
    }
    
    processAllContent() {
        // Target lesson content areas
        const contentAreas = document.querySelectorAll(
            '.content-item, .rich-text-content, .text-content-container, .details'
        );
        
        contentAreas.forEach(area => {
            this.processElement(area);
        });
    }
    
    processElement(element) {
        // Skip if already processed
        if (element.dataset.japaneseProcessed) return;
        
        // Process text nodes
        this.processTextNodes(element);
        element.dataset.japaneseProcessed = 'true';
    }
    
    processTextNodes(element) {
        const walker = document.createTreeWalker(
            element,
            NodeFilter.SHOW_TEXT,
            {
                acceptNode: (node) => {
                    // Skip if parent already has audio functionality
                    if (node.parentElement.classList.contains('japanese-audio-text') ||
                        node.parentElement.classList.contains('audio-btn')) {
                        return NodeFilter.FILTER_REJECT;
                    }
                    
                    // Only process nodes with Japanese text
                    return this.japaneseRegex.test(node.textContent) ? 
                        NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT;
                }
            }
        );
        
        const textNodes = [];
        let node;
        while (node = walker.nextNode()) {
            textNodes.push(node);
        }
        
        // Process each text node
        textNodes.forEach(textNode => {
            this.wrapJapaneseText(textNode);
        });
    }
    
    wrapJapaneseText(textNode) {
        const text = textNode.textContent;
        const segments = this.findJapaneseSegments(text);
        
        if (segments.length === 0) return;
        
        const fragment = document.createDocumentFragment();
        let lastIndex = 0;
        
        segments.forEach(segment => {
            // Add text before Japanese segment
            if (segment.start > lastIndex) {
                fragment.appendChild(
                    document.createTextNode(text.slice(lastIndex, segment.start))
                );
            }
            
            // Create clickable Japanese text element
            const audioSpan = document.createElement('span');
            audioSpan.className = 'japanese-audio-text';
            audioSpan.textContent = segment.text;
            audioSpan.setAttribute('data-japanese-text', segment.text);
            audioSpan.setAttribute('title', 'Click to hear pronunciation');
            audioSpan.style.cursor = 'pointer';
            
            // Add click handler
            audioSpan.addEventListener('click', (e) => {
                e.preventDefault();
                this.playText(segment.text, audioSpan);
            });
            
            fragment.appendChild(audioSpan);
            lastIndex = segment.end;
        });
        
        // Add remaining text
        if (lastIndex < text.length) {
            fragment.appendChild(
                document.createTextNode(text.slice(lastIndex))
            );
        }
        
        // Replace original text node
        textNode.parentNode.replaceChild(fragment, textNode);
    }
    
    findJapaneseSegments(text) {
        const segments = [];
        let currentSegment = null;
        
        for (let i = 0; i < text.length; i++) {
            const char = text[i];
            const isJapanese = this.isJapaneseChar(char);
            
            if (isJapanese) {
                if (!currentSegment) {
                    currentSegment = {
                        text: char,
                        start: i,
                        end: i + 1
                    };
                } else {
                    currentSegment.text += char;
                    currentSegment.end = i + 1;
                }
            } else {
                if (currentSegment) {
                    if (currentSegment.text.trim().length > 0) {
                        segments.push(currentSegment);
                    }
                    currentSegment = null;
                }
            }
        }
        
        // Handle segment at end
        if (currentSegment && currentSegment.text.trim().length > 0) {
            segments.push(currentSegment);
        }
        
        return segments;
    }
    
    isJapaneseChar(char) {
        const code = char.charCodeAt(0);
        return (
            (code >= 0x3040 && code <= 0x309F) || // Hiragana
            (code >= 0x30A0 && code <= 0x30FF) || // Katakana
            (code >= 0x4E00 && code <= 0x9FAF) || // Kanji
            (code >= 0x3000 && code <= 0x303F)    // Japanese punctuation
        );
    }
    
    playText(text, element) {
        if ('speechSynthesis' in window) {
            // Add visual feedback
            element.classList.add('playing-audio');
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ja-JP';
            utterance.rate = 0.8;
            utterance.pitch = 1.0;
            
            // Try to use a Japanese voice if available
            const voices = speechSynthesis.getVoices();
            const japaneseVoice = voices.find(voice => voice.lang.startsWith('ja'));
            if (japaneseVoice) {
                utterance.voice = japaneseVoice;
            }
            
            utterance.addEventListener('end', () => {
                element.classList.remove('playing-audio');
            });
            
            utterance.addEventListener('error', () => {
                element.classList.remove('playing-audio');
                console.error('Speech synthesis error');
            });
            
            speechSynthesis.speak(utterance);
        } else {
            console.error('Speech synthesis not supported');
        }
    }
}

// Initialize the Japanese text audio system
const japaneseAudioSystem = new JapaneseTextAudioSystem();
</script>
{% endblock %}
